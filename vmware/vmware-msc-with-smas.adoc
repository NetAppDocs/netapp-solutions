---
sidebar: sidebar
permalink: vmware/vmware-msc-with-smas.html
keywords: NetApp Solutions, vMSC, Metro Storage Cluster, SnapMirror active sync, Business Continuity, SMBC, ONTAP Tools
summary:
---

= VMware Metro Storage Cluster with SnapMirror active sync
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./../media/

[.lead]
link:https://docs.netapp.com/us-en/ontap-apps-dbs/vmware/vmware_vmsc_overview.html[VMware vSphere Metro Storage CLuster (vMSC)] is a stretched cluster solution with link:https://docs.netapp.com/us-en/ontap/snapmirror-active-sync[SnapMirror active sync (SM-as)] to provide
* Workload mobility across availability zones or sites.
* downtime avoidance
* disaster avoidance
* fast recovery

image::vmware-msc-with-smas-image01.png[vMSC with SnapMirror active sync architecture]

SnapMirror active sync supports ASA, AFF and FAS storage arrays. It is recommended to use same type (Performance/Capacity models) on both fault domains. Currently, only block protocols like FC and iSCSI are supported. For further support guidelines, refer link:https://imt.netapp.com/matrix/[Interoperability Matrix Tool] and link:https://hwu.netapp.com/[Hardware Universe]

vMSC supports two different deployment models named Uniform host access and Non-uniform host access. In Uniform host access configuration, every host on the cluster has access to LUN on both fault domains. It is typically used in different availability zones in same datacenter.

image:vmware-msc-with-smas-image02.png[vMSC Uniform vs Non-Uniform host access mode]

In Non-Uniform host access configuration, host has access only to local fault domain. It is typically used in different sites where running multiple cables across the fault domains are restrictive option.

NOTE: In Non-Uniform host access mode, the VMs will be restarted in other fault domain by vSphere HA. Application availability will be impacted based on its design. Non-Uniform host access mode is supported only with ONTAP 9.15 onwards.


== Prerequisites

* link:https://docs.netapp.com/us-en/netapp-solutions/vmware/vmware_vcf_asa_supp_mgmt_iscsi.html#deployment-steps[VMware vSphere hosts deployed with dual storage fabric (Two HBAs or Dual VLAN for iSCSI) per host].
* link:https://docs.netapp.com/us-en/ontap/networking/combine_physical_ports_to_create_interface_groups.html[Storage Arrays are deployed with link aggregation for data ports (for iSCSI)].
* link:https://docs.netapp.com/us-en/netapp-solutions/vmware/vmware_vcf_asa_supp_mgmt_iscsi.html#deployment-steps[Storage VM and LIFs are available]
* link:https://docs.netapp.com/us-en/ontap/snapmirror-active-sync/prerequisites-reference.html#networking-environment[Inter-Cluster latency round trip time must be less than 10 milliseconds].
* link:https://docs.netapp.com/us-en/ontap/mediator/index.html[ONTAP Mediator VM is deployed on different fault domain]
* link:https://docs.netapp.com/us-en/ontap/task_dp_prepare_mirror.html[Cluster Peer relationship is established]
* link:https://docs.netapp.com/us-en/ontap/peering/create-intercluster-svm-peer-relationship-93-later-task.html[SVM Peer relationship is established]
* link:https://docs.netapp.com/us-en/ontap/snapmirror-active-sync/mediator-install-task.html#initialize-the-ontap-mediator[ONTAP Mediator registered to ONTAP cluster]

TIP: If using self-signed certificate, the CA certificate can be retrieved from the <installation path>/ontap_mediator/server_config/ca.crt on mediator VM. 

== Manual steps of provisioning iSCSI datastore with non-uniform host access mode utilizing ONTAP System Manager UI.

Note: ONTAP Tools 10.2 or above can be used to provision stretched datastore with non-uniform host access mode without switching multiple interfaces. This section is just for reference if ONTAP Tools is not used.

. Note down one of the iSCSI data lif IP address from the local fault domain storage array.
image:vmware-msc-with-smas-image04.png[System Manager iSCSI Lifs]
. On vSphere host iSCSI Storage Adapter, add that iSCSI IP under the Dynamic Discovery tab.
image:vmware-msc-with-smas-image03.png[Add iSCSI server for dynamic discovery]
+
NOTE: For Uniform access mode, need to provide the source and target fault domain iSCSI data lif address.
. Repeat the above step on vSphere hosts for the other fault domain adding its local iSCSI data lif IP on Dynamic Discovery tab.
. With proper network connectivity, four iSCSI connection should exist per vSphere host that has two iSCSI VMKernel nics and two iSCSI data lifs per storage controller.
image:vmware-msc-with-smas-image05.png[iSCSI connection info]
. Create LUN using ONTAP System Manager, setup SnapMirror with replication policy AutomatedFailOverDuplex, pick the host initiators and set host proximity.
image:vmware-msc-with-smas-image06.png[Create LUN with AutomatedFailOverDuplex]
. On other fault domain storage array, create the SAN initiator group with its vSphere host initiators and set host proximity. 
image:vmware-msc-with-smas-image09.png[SAN initiator group]
+
NOTE: For Uniform access mode, the igroup can be replicated from source fault domain.
. Map the replicated LUN with same mapping ID as in source fault domain.
image:vmware-msc-with-smas-image10.png[LUN Mapping ID]
. On vCenter, right click on vSphere Cluster and select Rescan Storage option.
image:vmware-msc-with-smas-image07.png[Rescan storage]
. On one of the vSphere host in the cluster, check the newly created device shows up with datastore showing Not Consumed.
image:vmware-msc-with-smas-image08.png[iSCSI Device list on vSphere host]
. On vCenter, right click on vSphere Cluster and select New Datastore option.
image:vmware-msc-with-smas-image07.png[New Datastore]
. On Wizard, remember to provide the datastore name and select the device with right capacity & device id.
image:vmware-msc-with-smas-image11.png[Datastore creation on iSCSI device]
. Verify the datastore is mounted on all hosts on cluster across both fault domains.
image:vmware-msc-with-smas-image12.png[Datastore on source host]
+
image:vmware-msc-with-smas-image13.png[Datastore on destination host]
+
NOTE: The above screenshots shows Active I/O on single controller since we used AFF. For ASA, it will have Active IO on all paths.



== Provisioning and Protecting the datastore to enable uniform host access mode of vMSC with ONTAP Tools.

== VM protection with Snapcenter plugin for VMware vSphere.

== Monitoring with Harvest and Grafana.
