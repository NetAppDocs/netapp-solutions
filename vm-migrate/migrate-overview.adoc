---
sidebar: sidebar
permalink: vm-migrate/migrate-overview.html
keywords: netapp, vmware, esxi, vm, migration, openshift, virtualization, hyper-v, proxmox
summary: 
---

= Migrating virtual machines (VMs) between virtualization environments (Shift Toolkit)
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ../media/

[.lead]
With the NetApp Shift toolkit, migrating virtual machines (VMs) is no longer a concern. This standalone product enables fast and efficient migration of VMs from VMware ESXi to Microsoft Hyper-V. Additionally, it supports disk-level conversions between various virtual disk formats.

== Usecase

EEvery organization is now seeing the benefit of having multi-hypervisor environment. With recent changes in the market, every organization is deciding on the best course(s) of action by weighing technical and commercial risks including migrating workload VMs to alternate hypervisors and focus on achieving business-defined objectives, and controlling vendor lock-in. This enables them to operate in an optimized fashion wrt licensing cost and extend IT budget on the right areas than spending for those unused cores on a specific hypervisor. However, the challenge has always been around migration time and the associated downtime. 

With the NetApp Shift toolkit, migrating virtual machines (VMs) is no longer a concern. This standalone product enables fast and efficient migration of VMs from VMware ESXi to Microsoft Hyper-V. Additionally, it supports disk-level conversions between various virtual disk formats. Thanks to the out-of-the-box capabilities provided by ONTAP, these migrations can be incredibly swift, with minimal downtime. For example, converting a 1TB VMDK file typically takes a couple of hours, but with the Shift toolkit, it can be completed in seconds.

== Toolkit Overview

The NetApp Shift toolkit is an easy-to-use, graphical user interface (GUI) solution that 
allows to migrate virtual machines (VMs) between different hypervisors and convert virtual disk formats. It utilizes NetApp FlexClone® technology to quickly convert VM hard disks. Additionally, the toolkit manages the creation and configuration of destination VMs.

Shift toolkit provides flexibility in a multi-hypervisor environment by supporting bidirectional conversion between the following hypervisors:

* VMware ESXi to Microsoft Hyper-V
* Microsoft Hyper-V to VMware ESXi (Upcoming release)

Shift toolkit supports disk-level conversions of virtual disks between hypervisors for the following disk formats:

* VMware ESX to Microsoft Hyper-V (virtual machine disk [VMDK] to virtual hard disk format [VHDX])
* VMware ESX to KVM compatible hypervisors (VMDK to QCOW2)

image:shift-toolkit-image1.png["Figure showing input/output dialog or representing written content"]

Shift toolkit can be downloaded link:https://mysupport.netapp.com/site/tools/tool-eula/netapp-shift-toolkit[here] and is available for Windows Systems only.

=== Benefits of VM portability

ONTAP is ideal for any hypervisor and in any hyperscalar. With FlexClone technology. VM portability in minutes is a reality than waiting for longer downtimes or settling down with pass through options.

Shift toolkit:

* helps minimize downtime and enhances business productivity.
* offers choice and flexibility by reducing licensing costs, lock-in, and commitments to a single vendor.
* enables organizations looking to optimize VM licensing costs and extend IT budgets.
* reduces virtualization costs with VM portability and is offered free from NetApp.

=== How Shift toolkit works

At conversion time, Shift toolkit connects to VMware ESXi and Microsoft Hyper-V hosts and to shared NetApp storage. Shift toolkit leverages FlexClone to convert VM hard drives from one hypervisor to another by using three key NetApp technologies:

* Single volume and multiple protocols
+
With NetApp ONTAP, multiple protocols can be easily used to access a single volume. For example, VMware ESXi can access a volume that is enabled with the Network File System (NFS) protocol, and Microsoft Hyper-V can access the same volume with the CIFS/SMB protocol.

* FlexClone technology
+
FlexClone allows the rapid cloning of entire files or volumes with no data copy. Common blocks on the storage system are shared between multiple files or volumes. As a result, large VM disks can be cloned very quickly.

* VM disk conversion
+
 The NetApp PowerShell Toolkit and Shift toolkit contain a large number of workflows that can be used to perform various actions on a NetApp storage controller. Included are PowerShell cmdlets that convert virtual disks to different formats. For example, VMware VMDK can be converted to Microsoft VHDX, and vice versa. These conversions are performed with FlexClone, which enables very rapid cloning and conversion of disk formats in one step.

image:shift-toolkit-image2.png["Figure showing input/output dialog or representing written content"]

==== Protocols and communication methods

Shift toolkit uses the following protocols during conversion or migration operations.

* HTTPS - Used by the Shift toolkit to communicate with the Data ONTAP cluster. 
* VI Java (openJDK), VMware PowerCLI - Used to communicate with VMware ESXi.
* Windows PowerShell module - Used to communicate with Microsoft Hyper-V.

== Installing and Setting Up Shift toolkit

To get started with the toolkit, use a windows operating system on a designated virtual machine and make sure you meet the prerequisites, then install the package.

Shift toolkit can be run on Windows 2019 and 2022 version. 

* Download the Shift toolkit package from link:https://mysupport.netapp.com/site/tools/tool-eula/netapp-shift-toolkit[NetApp Toolchest]
* Unzip the package
* Run the exe to install and start the service

Shift toolkit provides 2 packages:

* Online (~130MB in size), and
* Offline (~1.1GB in size). 

As the name indicates, online installer package downloads and installs the necessary pre-requisites from the internet. 

image:shift-toolkit-image3.png["Figure showing input/output dialog or representing written content"]

While online installation offers convenience, offline installation provides more control over the installation process. With offline installation package, all the necessary pre-requisites are bundled within the package to install Shift toolkit. One major advantage of offline installation is that it allows to install Shift toolkit on virtual machines without an internet connection.

TIP: Use the appropriate package for deployment. With offline mode, there is no need to modify the proxy settings as all the pre-requisites and files required are bundled.

Shift toolkit can be installed on a virtual machine running VMware or Microsoft Hyper-V server as long as there is connectivity between source and target environments, and it is a best practice to install Shift toolkit on its own VM. This approach allows you to target different Microsoft Hyper-V servers or VMware ESXi servers with a single Shift toolkit server.

NOTE: Install Shift toolkit on a dedicated VM.

=== Pre-requisites:

==== Hardware requirements

Ensure that Shift server host meets minimum hardware requirements. 

Hardware Requirements:

* CPU: 4 vCPUs
* Memory: 8 GB minimum
* Disk Space: minimum 100 GB

NOTE: Must have 650 MB disk space available for installation.

==== Connectivity requirements

* Ensure the hypervisor and storage environment is configured so that Shift toolkit can interact properly with all components in the environment.
* Shift toolkit must be installed on a standalone Windows server (physical or virtual).
* The Shift server, Data ONTAP CIFS server and Hyper-V servers must be on the same Windows Active Directory domain.
* Multiple LIFs for CIFS and NFS are supported for use with Storage Virtual Machine when doing VM conversions. The Hyper-V server and ESXi hosts access the Storage Virtual Machine (SVM) at the IP addresses of these LIFs.
* For CIFS operations, the time settings for the Windows domain controller and the NetApp storage controller must be synchronized.

=== ONTAP Storage Configurations 
==== Create a New SVM (recommended)

Although Shift toolkit permits the use of an existing SVM, it is a NetApp best practice to create a new SVM. Move the VMs to be migrated or converted to a new designated NFS v3 datastore residing on a dedicated Data ONTAP Storage Virtual Machine (SVM) using Storage vMotion. This svmotion based migration is performed without any downtime for the VM. With this approach, the VMs that are designated to be migrated do not reside on the production SVM. Use the ONTAP CLI, NetApp PowerShell toolkit or System Manager to create the new SVM.

Follow the steps provided in this link:https://docs.netapp.com/us-en/ontap/networking/create_svms.html[link] to provision a new SVM allowing both NFS and SMB protocol.

NOTE: It is a good practice creating a new SVM to be sure that the SVM meets the Shift toolkit requirements without having to modify the production SVM in ways that might be disruptive.

NOTE: The new SVM should have both NFS and SMB protocol enabled. The volume provisioned should also have both NFS and SMB enabled.

==== Qtree requirements

A qtree should be created on the volume that will be used for hosting the VMs to be converted from VMware to Hyper-V so as to segregate and store the VHDX files or for the qcow2 or VHDX files that will be converted from VMDKs.

* For ESX to Hyper-V conversion, Shift toolkit places the converted VHDX’s on a qtree (with NTFS security style) within the same volume. 
* For ESX VMDK to QCOW2 conversions, a qtree with UNIX security style should be used. 

The Shift toolkit does not verify the security style of the qtrees. Therefore, it is important to create qtrees with the appropriate security style based on the target hypervisor and disk type.

NOTE: The destination path must be on the same volume of the source VM.

NOTE: Assign the correct security style to the qtree according to the target hypervisor type and disk format.

NOTE: If the converted qcow2 files are intended for use with OpenShift virtualization, there's an exception: these files can be placed directly on the volume without utilizing a qtree. To achieve this, employ Shift toolkit APIs to convert VMDK files to qcow2 format and place them directly within the volume.

Follow the steps provided in this link:https://docs.netapp.com/us-en/ontap/nfs-config/create-qtree-task.html[link] to create a qtree with the right security style.

image:shift-toolkit-image4.png["Figure showing input/output dialog or representing written content"]

==== CIFS Share requirements:

For Hyper-V migrations, create a share where the converted VM data will be stored. Make sure that the NFS share (used to store the VMs to be converted) and the destination share (used to store the converted VMs) reside on the same volume. Shift toolkit does not support spanning on multiple volumes.

Follow the steps provided in this link:https://docs.netapp.com/us-en/ontap/smb-config/create-share-task.html[link] to create the share with the appropriate properties. Ensure to select continuous availability property along with the other default ones.

image:shift-toolkit-image5.png["Figure showing input/output dialog or representing written content"]

image:shift-toolkit-image6.png["Figure showing input/output dialog or representing written content"]

NOTE: SMB 3.0 must be enabled, this is enabled by default.

NOTE: Ensure continuously available property is enabled.

NOTE: Export policies for SMB must be disabled on the storage virtual machine (SVM)

NOTE: The domain to which the CIFS server and Hyper-V servers belong must permit both Kerberos and NTLMv2 authentication.

NOTE: ONTAP creates the share with the Windows default share permission of Everyone / Full Control.

=== Supported operating systems

Ensure that a supported versions of Windows and Linux guest operating systems are used for conversion and that Shift toolkit supports the version of ONTAP.

*Supported VM guest operating systems*

The following versions of Windows are supported as guest operating systems for VM conversions:

* Windows 10
* Windows 11
* Windows Server 2016 
* Windows Server 2019
* Windows Server 2022
* Windows Server 2025

The following versions of Linux are supported as guest operating systems for VM conversions:

* CentOS Linux 7.x
* Red Hat Enterprise Linux 6.7 or later
* Red Hat Enterprise Linux 7.2 or later
* Red Hat Enterprise Linux 8.x
* Red Hat Enterprise Linux 9.x
* Ubuntu 2018
* Ubuntu 2022
* Ubuntu 2024
* Debian 10
* Debian 11
* Debian 12
* Suse 12
* Suse 15

NOTE: CentOS Linux/RedHat for Red Hat Enterprise Linux 5 is not supported.

NOTE: Windows Server 2008 is not supported, but the conversion process should work fine. Proceed at your own risk; however, we have received reports from customers who successfully used the Shift toolkit to convert Windows 2008 VMs. It's important to update the IP address after migration, as the PowerShell version used for automating IP assignment is not compatible with the older version running on Windows Server 2008.

*Supported versions of ONTAP*

Shift toolkit supports platforms that are running ONTAP 9.14.1 or later

*Supported versions of Hypervisors*

VMware: Shift toolkit is validated against vSphere 7.0.3 and later
Hyper-V: Shift toolkit is validated against Hyper-V role running on Windows Server 2019, Windows Server 2022 and Windows Server 2025

NOTE: In the current release, end to end virtual machine migration is supported with Hyper-V only. 

NOTE: In the current release, for KVM as the destination, VMDK to qcow2 conversion is the only supported workflow. Hence, if KVM is selected from the dropdown, hypervisor details are not required. The qcow2 disk can be used for provisioning virtual machine on KVM variants.

=== Installation

. Download link:https://mysupport.netapp.com/site/tools/tool-eula/netapp-shift-toolkit[Shift toolkit package] and unzip it.
+
image:shift-toolkit-image7.png["Figure showing input/output dialog or representing written content"]

. Initiate the Shift toolkit installation by double-clicking the downloaded .exe file. 
+
image:shift-toolkit-image8.png["Figure showing input/output dialog or representing written content"]
+
NOTE: All the prechecks are performed and if the minimum requirements are not met appropriate error or warning messages are displayed.

. The installer will begin the installation process. Select the appropriate location or use the default placement and click Next.
+
image:shift-toolkit-image9.png["Figure showing input/output dialog or representing written content"]

. The installer will prompt to select the IP address that will be used to access Shift toolkit UI.
+
image:shift-toolkit-image10.png["Figure showing input/output dialog or representing written content"]
+
NOTE: The setup process allows to select the right IP address using a dropdown option if the VM is assigned with multiple NICs.

. In this step, the installer shows all the required components that will be automatically downloaded and installed as part of the process.  The following are the mandatory components that needs to be installed for proper functioning of Shift toolkit - MongoDB, Windows PowerShell 7, NetApp ONTAP PowerShell Toolkit, Policy file editor, Credential Manage, VMware.PowerCLI package and Java OpenJDK which is all packed into the package. 
+
Click *Next*
+
image:shift-toolkit-image11.png["Figure showing input/output dialog or representing written content"]

. Review the JAVA OpenJDK GNU licensing information. Click Next.
+
image:shift-toolkit-image12.png["Figure showing input/output dialog or representing written content"]

. Keep the default for creating the desktop shortcut and click Next.
+
image:shift-toolkit-image13.png["Figure showing input/output dialog or representing written content"]

. Setup is now ready to proceed with install. Click Install.
+
image:shift-toolkit-image14.png["Figure showing input/output dialog or representing written content"]

. The installation starts and the process will download the required components and install them. Once done, click Finish.
+
image:shift-toolkit-image15.png["Figure showing input/output dialog or representing written content"]

NOTE: If the Shift toolkit VM does not have internet, the offline installer will perform the same steps but will install the components using the packages included in the executable.

image:shift-toolkit-image16.png["Figure showing input/output dialog or representing written content"]

NOTE: The installation can take 8-10mins.

=== Performing an upgrade

Download the link:https://mysupport.netapp.com/site/tools/tool-eula/netapp-shift-toolkit/download[upgrade package] starting with “update” and follow the below steps:

image:shift-toolkit-image17.png["Figure showing input/output dialog or representing written content"]

. Extract the files to a designated folder.
. After the extraction, stop NetApp Shift service.
. Copy all the files from the extracted folder to the install directory and overwrite the files when prompted. 
. Once done, run the update.bat using “Run as administrator” option and enter the Shift Toolkit VM IP when prompted. 
. This process will upgrade and start the Shift service.

=== Using the GUI 

==== Run Shift toolkit 

* Using the browser, access Shift toolkit UI by entering the "http://<IP address specified during installation>:3001"
+
NOTE: Use Google chrome or Internet explorer for best experience.

* Access the UI using default credentials as below:
+
Username: admin
+
Password: admin

NOTE: The admin credentials can be changed using “Change Password” option.

image:shift-toolkit-image18.png["Figure showing input/output dialog or representing written content"]

Accept the legal EULA by clicking on “Accept and Continue”.

image:shift-toolkit-image19.png["Figure showing input/output dialog or representing written content"]

==== Shift Toolkit Configuration

Once the storage and connectivity to both the source and destination hypervisors have been configured properly, begin configuring Shift toolkit to automate the migration or conversion of the virtual machine VMDK to appropriate format, leveraging the FlexClone functionality.

===== Add Sites

The first step is to discover and add the source vCenter and then the target Hyper-V details (both hypervisors and storage) to Shift toolkit. Open Shift toolkit in a supported browser and use the default username and password (admin/admin) and click on “Add Sites”. 

image:shift-toolkit-image20.png["Figure showing input/output dialog or representing written content"]

NOTE: Sites can also be added using Discover option.  

Add the following platforms:

*Source*

** Source Site Details
*** Site Name - Provide a name for the site
*** Hypervisor – Select VMware as the source (only option available during GA)
*** Site Location – Select the default option
*** Connector – Select the default selection

Once filled, click Continue.

image:shift-toolkit-image21.png["Figure showing input/output dialog or representing written content"]

** Source vCenter
*** Endpoint - Enter the IP address or FQDN of the vCenter server
*** Username - username to access the vCenter (in UPN format: `username@domain.com`)
*** vCenter Password – Password to access vCenter for performing inventory of the resources.
*** vCenter SSL Thumbprint (optional) 

Select “Accept Self signed certificate” and click Continue.

image:shift-toolkit-image22.png["Figure showing input/output dialog or representing written content"]

** ONTAP Storage system credentials

image:shift-toolkit-image23.png["Figure showing input/output dialog or representing written content"]

Once added, Shift toolkit will perform an automatic discovery and display the VMs along with the relevant metadata information.  Shift toolkit will automatically detect the networks and portgroups used by the VMs and will populate them. 

NOTE: If any modifications are made to the source site, ensure to run the discovery to fetch the latest information. This can be done by clicking  on 3 dots against the site name and click on “Discover Site”.

NOTE: The VM inventory is auto-refreshed every 24 hours.

image:shift-toolkit-image24.png["Figure showing input/output dialog or representing written content"]

To view the data for a specific vCenter, go to the dashboard, click on “View VM List” against the appropriate site name. The page will display the VM inventory along with the VM attributes.

Next step is to add the destination hypervisor. To add, click on “Add New Site” and select “Destination”.

*Destination*

image:shift-toolkit-image25.png["Figure showing input/output dialog or representing written content"]

** Destination Site Details
*** Site Name - Provide a name for the site
*** Hypervisor – Select Hyper-V or KVM as the target
*** Site Location – Select the default option
*** Connector – Select the default selection

Once filled, click Continue.

image:shift-toolkit-image26.png["Figure showing input/output dialog or representing written content"]

Based on the hypervisor selection, fill in the necessary details. 

** Destination Hyper-V details
*** Hyper-V Standalone or failover cluster manager IP address or FQDN
*** Username - username to access (in UPN format: `username@domain.com` or domain\administrator)
+
Password – Password to access Hyper-V host or FCI instance for performing inventory of the resources.
+
Select “Accept Self signed certificate” and click Continue.

image:shift-toolkit-image27.png["Figure showing input/output dialog or representing written content"]

Once done, Click Continue

NOTE: Shift toolkit does not communicate with System Center directly in the current release.

NOTE: The Hyper-V FCI and host discovery relies on DNS resolution. Ensure the hostnames should be resolvable from Shift toolkit VM. In case resolution fails, update the host file (C:\Windows\System32\drivers\etc\hosts) and retry the discovery operation. 

*ONTAP Storage system*

image:shift-toolkit-image28.png["Figure showing input/output dialog or representing written content"]

NOTE: The source and destination storage system should be the same as the disk format conversion happens at the volume level and within the same volume.

image:shift-toolkit-image29.png["Figure showing input/output dialog or representing written content"]

Next step is to group the required VMs into their migration groups as resource groups.

==== Resource Groupings

Once the platforms have been added, group the VMs you want to migrate or convert into resource groups.  Shift toolkit resource groups allow you to group set of dependent VMs into logical groups that contain their boot orders and boot delays.

NOTE: Ensure the Qtrees are provisioned (as mentioned in the pre-requisite section) before creating the resource groups. 

To start creating resource groups, click on the “Create New Resource Group” menu item.

. Access Resource groups, click on “Create New Resource Group”.
+
image:shift-toolkit-image30.png["Figure showing input/output dialog or representing written content"]

. On the “New resource group”, select the Source site from the dropdown and click “Create”
. Provide Resource Group Details and select the workflow. The workflow provides two options 
.. Clone based Migration – performs end to end migration of the VM from source hypervisor to destination hypervisor. 
.. Clone based Conversion – Performs conversion of the disk format to the selected hypervisor type. 
+
image:shift-toolkit-image31.png["Figure showing input/output dialog or representing written content"]

. Click on “Continue”
. Select appropriate VMs using the search option. The default filter option is “Datastore”.
+
NOTE: Move the VMs to convert or migrate to a designated datastore on a newly created ONTAP SVM before conversion. This helps isolating the production NFS datastore and the designated datastore can be used for staging the virtual machines.
+
image:shift-toolkit-image32.png["Figure showing input/output dialog or representing written content"]
+ 
NOTE: The datastore dropdown in this context will only show NFSv3 datastores. NFSv4 datastores will not be displayed.
+
image:shift-toolkit-image33.png["Figure showing input/output dialog or representing written content"]

. Update the migration details by selecting “Destination Site”, Destination Hyper-V entry” and Datastore to Qtree mapping. 
+
image:shift-toolkit-image34.png["Figure showing input/output dialog or representing written content"]
+
NOTE: Make sure that the destination path (where the converted VMs are stored) is set to a qtree when converting VMs from ESX to Hyper-V. Set the destination path to the appropriate qtree.
+
NOTE: Multiple qtrees can be created and used for storing the converted VM disks accordingly.

. Select the Boot Order and Boot delay (secs) for all the selected VMs. Set the order of power on sequence by selecting each virtual machine and setting up the priority for it. 3 is the default value for all virtual machines.
+
Options are as follows: 
+
1 – The first virtual machine to power on
3 – Default
5 – The last virtual machine to power on
+
image:shift-toolkit-image35.png["Figure showing input/output dialog or representing written content"]

. Click on “Create Resource Group”.
+
image:shift-toolkit-image36.png["Figure showing input/output dialog or representing written content"]
+
NOTE: In the event of the need to modify the resource group so as to add or remove virtual machines, use this option  against the resource group name and select “Edit Resource Group”.

===== Blueprints

To migrate or convert virtual machines, a plan is necessary. Select the source and destination hypervisor platforms from the drop down and pick the resource groups to be included in this blueprint, along with the grouping of how applications should be powered on (i.e. domain controllers, then tier-1, then tier-2, etc). These are often called as migration plans as well. To define the blueprint, navigate to the “Blueprints” tab and click on “Create New Blueprint”. 

To start creating blueprint, click on the “Create New Blueprint”.

. Access Blueprints, click on “Create New Blueprint”.
+
image:shift-toolkit-image37.png["Figure showing input/output dialog or representing written content"]

. On the “New Blueprint”, provide a name for plan and add necessary host mappings by selecting Source Site > associated vCenter, Destination Site and the associated Hyper-V hypervisor.  
. Once mappings are done, select the cluster and host mapping.
+
image:shift-toolkit-image38.png["Figure showing input/output dialog or representing written content"]

. Select Resource Group Details and click on “Continue”
+
image:shift-toolkit-image39.png["Figure showing input/output dialog or representing written content"]

. Set Execution Order for Resource Group. This option enables to select the sequence of operations when multiple resource groups exist. 
. Once done, select Network Mapping to the appropriate virtual switch.  The virtual switches should already be provisioned within Hyper-V.
+
image:shift-toolkit-image40.png["Figure showing input/output dialog or representing written content"]
+
NOTE: On Hyper-V side, the virtual switch type “External” is the only supported option for network selection. 
+
NOTE: For test migration, “Do no configure Network” is the default selection and Shift toolkit does not perform IP address assignment. Once the disk is converted and virtual machine is bought on Hyper-V side, manually assign the bubble network switches to avoid any colliding with production network.
+
image:shift-toolkit-image41.png["Figure showing input/output dialog or representing written content"]

. Based on the selection of VMs, storage mappings will be automatically selected.
+
NOTE: Make sure the qtree is provisioned beforehand and the necessary permissions are assigned so the virtual machine can be created and powered ON from SMB share.

. Under VM details, provide service account and valid user credentials for each OS type. This is used to connect to the virtual machine to create and run certain scripts that are necessary for removing VMware tools and backing up IP configuration details.
.. For Windows based OS, it is recommended to use a user with local administrator privileges. Domain credential can also be used, however ensure there is a user profile existing on the VM before conversion, otherwise domain credentials won’t work as it would look for domain authentication when there is no network connected. 
.. In case of Linux distro-based guest VMs, provide a user that can execute sudo commands without password meaning the user should be part of the sudoers list or added as a new configuration file to the /etc/sudoers.d/ folder.
+
image:shift-toolkit-image42.png["Figure showing input/output dialog or representing written content"]

. Again under VM details, select the relevant IP config option. By default, “Do not configure” is selected. 
.. To migrate VMs with the same IPs from the source system, select “Retain IP”. 
.. To migrate VMs using static IPs in the source system and to assign DHCP on the target VMs, then select “DHCP”.
+
Make sure the following requirements are met for this functionality to work:
+
* Ensure the VMs are powered on during the prepareVM phase and up to the scheduled migration time.
* For VMware VMs, ensure that VMware Tools are installed.
* Ensure the preparation script is run on the source VM by an account with administrator privileges on windows OS and with sudo privileges with no password option on Linux based distro OS to create cron jobs.

. The next step is VM configuration. 
.. Optionally resize the VMs CPU/RAM parameters which can be very helpful for resizing purposes. 
.. Boot Order override: Also modify the Boot Order and Boot delay (secs) for all the selected VMs across the resource groups. This is an additional option to modify the boot order if any changes required from what was selected during Resource group boot order selection. By default, the boot order selected during resource group selection is used, however any modifications can be done at this stage. 
.. Power ON: Uncheck this option if workflow should not power ON the virtual machine. Default option is ON meaning the VM will be powered ON.
.. Remove VMware tools: Shift toolkit removes VMware tools after the conversion. This option is selected by default. This is an be unselected if the plan is to execute customer’s own customized scripts.
.. Generation: Shift toolkit uses the following rule of thumb and defaults to the appropriate one- Gen1 > BIOS and Gen2 > EFI. No selection is possible for this option.
.. Retain MAC: The MAC address of the respective VMs can be retained to overcome licensing challenges for those applications relying on MAC. 
.. Service Account override: This option allows to specify a separate service account if the global one cannot be used.
+
image:shift-toolkit-image43.png["Figure showing input/output dialog or representing written content"]

. Click “Continue”.
. In the next step, schedule the migration by selecting the checkbox to set the date and time. Make sure all the virtual machines (VMs) are prepared and powered off before the scheduled date. Once done, click on “Create Blueprint”.
+
image:shift-toolkit-image44.png["Figure showing input/output dialog or representing written content"]
+
NOTE: While scheduling, choose a date that is at least 30 minutes ahead of the current Shift VM time. This is to ensure the workflow gets enough time to prepare the VMs within the resource group.

. Once the blueprint is created, a prepareVM job is initiated and it automatically runs scripts on the source VMs to prepare them for migration
+
image:shift-toolkit-image45.png["Figure showing input/output dialog or representing written content"]
+
This job runs a script using invoke-VMScript method to copy the necessary scripts for removing VMware tools and backing up network configuration details, including IP address, routes, and DNS information, which will be used to maintain the same settings on the target VM. 
+
* For Windows-based operating systems, the default location where the preparation scripts are stored is the “C:\NetApp”  folder. 
+
image:shift-toolkit-image46.png["Figure showing input/output dialog or representing written content"]
+
* For Linux-based VMs, the default location where the preparation scripts are stored is /NetApp and the /opt directory.
+
image:shift-toolkit-image47.png["Figure showing input/output dialog or representing written content"]
+
NOTE: For a Linux source VM running CentOS or Red Hat, Shift toolkit is intelligent to automatically install the necessary Hyper-V drivers. These drivers must be present in the source VM before the disk conversion to ensure the VM can boot successfully after the conversion.
+
NOTE: For detailed information, refer to link:https://access.redhat.com/solutions/3465011[System stuck in dracut after the migration of a RHEL VM to hyper-v].
+
Once the prepareVM job completes successfully (as shown in the screenshot below), the VMs are ready for migration, and the blueprint status will update to "Active."
+
image:shift-toolkit-image48.png["Figure showing input/output dialog or representing written content"]
+
image:shift-toolkit-image49.png["Figure showing input/output dialog or representing written content"]
+
Migration will now happen at the set time or can be started manually by clicking on Migrate option.

==== Migration

Once the blueprint is created, “Migrate” option can be exercised. During migrate option, shift toolkit performs a series of steps to convert the disk format and use the converted disk to create virtual machines on Hyper-V host as defined in the blueprint. 

The high-level steps performed are as follows:

Pre-requisite: The VMs must be turned OFF gracefully as per the planned maintenance time. downtime Power OFF VMs in the protection group – at source.

* Delete existing snapshots for all VMs in the blueprint 
* Trigger VM snapshots for Blueprint – at source
* Trigger volume snapshot before disk conversion
* Clone and convert VMDK to VHDx format for all VMs
* Power ON VMs in protection group – at target
* Register the networks on each VM
* Remove VMware tools and assign the IP addresses using trigger script or cron job depending on the OS type

===== Factors to consider

Before initiating the migration, make sure all the pre-requisites are met (which is covered in detail in this the pre-requisites section of this document). Here's a quick checklist for a recap:

* Ensure the Shift VM is part of the domain
* Ensure CIFS share is configured with appropriate permissions
* The qtree used for migration or conversion have the right security style
* As a quick test, try creating a VM using Hyper-V manager from any of the Hyper-V host within the cluster and place the VHDX on the CIFS share (referred in bullet – a). Try the same from Shift toolkit VM by adding Hyper-V management tools (either via “Programs and Features” or using “PowerShell” - add-windowsfeature rsat-hyper-v-tools)

NOTE: If there are failures, link:https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/manage/remotely-manage-hyper-v-hosts[enable delegation using any authentication protocol].

===== Network Tips and Considerations

The following network considerations must be considered:

* Ensure that the static IP addresses are available and not assigned to another VM

For Windows VMs:

* The prepare script makes a copy of the network config details (IP address space, Gateway address, DNS servers) and trigger script (during the migration) will reapply the network settings, be it a single NIC or multiple NICs based on the blueprint mapping. 
* After migration, windows device manager may still display the old network adapter information from pre-migration. While this doesn't affect the new network adapter created post-migration and won't cause IP conflicts, the script doesn't currently delete this old registration, so it remains visible.

For Linux VMs:

* The prepare script makes a copy of the network config details (IP address space, routes, DNS servers, network device names) and depending on the Linux distro identify the networking type used and apply the IP settings. The network reassignment script is set a cron job using crontab and triggered on boot. For instance, the cronjob will execute the script (after the migration) on the instance to reapply the network settings, be it a single NIC or multiple NICs based on the blueprint mapping. 
* In certain scenarios, the converted Hyper-V VMs will have interface names like eth0 or eth1 instead of ens192 or 33 which was on the source side. In this case, the script will update the network config details to match the new interface names. If predictable names are in use (like modern systems) and the interface name is retained on the Hyper-V side, the script will skip the network side of it and only remove VMware tools and then reboot the VM. 
* Shift toolkit currently supports NetworkManager, Netplan and ifconfig mechanisms and retains the IP as specified in the blueprint.

===== Phases and Options 

Here are the key phases and options of the migration process.

. Prepare VM – Prepare the VMs for the migration, ensures that all prerequisites are thoroughly completed.
. Migrate - Once the preparation is complete, select and migrate VMware VMs to Hyper-V. After the migration is complete, verify that the VMs have booted successfully, and the data has migrated properly.
. Test Migrate - Test migration simulates the migration by converting the VMDK to VHDX and creating Hyper-V VM by using converted VHDX file residing on the SMB share. The test migration does not permit network mapping configuration; this task should typically be performed manually to a bubble network.

NOTE: The Shift toolkit does not alter the source VM, except for copying the scripts needed for VM preparation. This allows for a swift rollback in case of conversion failures.

To trigger Migrate workflow with the configuration specified in the Blueprint, click on Migrate.

image:shift-toolkit-image50.png["Figure showing input/output dialog or representing written content"]

Once initiated, the workflow activates, and the conversion process follows the outlined steps to register the VM. If the VMs within the blueprint are not powered off, the Shift toolkit will prompt for a graceful shutdown before proceeding.

image:shift-toolkit-image51.png["Figure showing input/output dialog or representing written content"]

NOTE: We recommend that no more than ten conversions be triggered parallelly from the same ESXi source to the same Hyper-V destination

image:shift-toolkit-image52.png["Figure showing input/output dialog or representing written content"]

The conversion of VMDK to VHDx happens in seconds which makes this approach the fastest of all the options that are available for an additional cost. This also helps to reduce VM downtime during migration.

image:shift-toolkit-image53.png["Figure showing input/output dialog or representing written content"]

Once the job is complete, the status of the blueprint changes to “migration Complete”.

image:shift-toolkit-image54.png["Figure showing input/output dialog or representing written content"]

With migration complete, it’s time to validate the VMs on Hyper-V side. Below screenshot shows the VMs running on the Hyper-V host that was specified during the blueprint creation.

image:shift-toolkit-image55.png["Figure showing input/output dialog or representing written content"]

NOTE: Shift toolkit uses cron job that executes on boot. There are no ssh connections or equivalent created for Linux based VMs once the VMs are bought on Hyper-V hosts.

image:shift-toolkit-image56.png["Figure showing input/output dialog or representing written content"]

NOTE: After migration and the windows VMs are powered ON, shift toolkit uses PowerShell direct to connect to these windows-based guest VMs. PowerShell direct allows connection to windows-based guest VMs regardless of their network configuration or remote management settings.

NOTE: After conversion, all the VM disks on Windows OS except for the OS disk will be offline. This is because the NewDiskPolicy parameter is set to offlineALL on VMware VMs by default. The issue is caused by the default Microsoft Windows SAN policy. This policy is designed to prevent the activation of LUNs when booting Windows Server if they are being accessed by multiple servers. This is done to avoid any potential data corruption issues. This can be handled by running a PowerShell command: Set-StorageSetting -NewDiskPolicy OnlineAll 

==== Conversion

The Clone based conversion option allows to simply convert the virtual disk between hypervisors for the following disk formats: 

* VMware ESX to Microsoft Hyper-V (VMDK to VHDX) 
* VMware ESX to Red Hat KVM (VMDK to QCOW2) 

The converted qcow2 files are compatible with any KVM hypervisors. For example, a qcow2 file can be utilized with RHEL-based KVM using virt-manager to create a VM, as well as with ubuntu KVM Rocky Linux based KVM and others. The same can be used with Oracle Linux virtualization manager with a tweak and with OpenShift virtualization after importing using NetApp Trident. The goal is to provide the disk (converted in secs to mins) which can then be integrated into existing automation scripts used by organizations to provision the VM and assign the network. This approach helps reduce overall migration times, with disk conversion handled by Shift toolkit APIs and the remaining script bringing up the VMs.

In future releases, Shift toolkit will support end-to-end migration from VMware to other compatible KVM hypervisors. However, with the current release, the conversion can be performed via the UI or APIs.

===== Convert to QCOW2 format

To convert the virtual disks to QCOW2 format with NetApp Shift toolkit, follow these high-level steps:

* Create a destination site type specifying KVM as the hypervisor.
+
NOTE: Hypervisor details are not required for KVM.
+
image:shift-toolkit-image57.png["Figure showing input/output dialog or representing written content"]

* Create a resource group with the VMs for which the disk conversion is required
+
image:shift-toolkit-image58.png["Figure showing input/output dialog or representing written content"]
+
image:shift-toolkit-image59.png["Figure showing input/output dialog or representing written content"]
+
image:shift-toolkit-image60.png["Figure showing input/output dialog or representing written content"]

* Create the blueprint to convert the virtual disk to QCOW2 format.
+
image:shift-toolkit-image61.png["Figure showing input/output dialog or representing written content"]
+
image:shift-toolkit-image62.png["Figure showing input/output dialog or representing written content"]
+
image:shift-toolkit-image63.png["Figure showing input/output dialog or representing written content"]

* Designate a slot using the scheduling option. If the conversion is to be performed on an ad-hoc basis, leave the scheduling option unchecked. 
+
image:shift-toolkit-image64.png["Figure showing input/output dialog or representing written content"]

* Once the blueprint is created, a prepareVM job is initiated and it automatically runs scripts on the source VMs to prepare them for conversion. 
+
image:shift-toolkit-image65.png["Figure showing input/output dialog or representing written content"]

* Once the prepareVM job completes successfully (as shown in the screenshot below), the VM disks associated with the VMs are ready for conversion, and the blueprint status will update to "Active."
* Click "Convert" after scheduling the required downtime for the VMs.
+
image:shift-toolkit-image66.png["Figure showing input/output dialog or representing written content"]

* The convert operation uses a point-in-time snapshot. Power off the VM if needed and then retrigger the operation.
+
image:shift-toolkit-image67.png["Figure showing input/output dialog or representing written content"]

•	The convert operation executes each operation against the VM and respective disk to generate the appropriate format.
+
image:shift-toolkit-image68.png["Figure showing input/output dialog or representing written content"]

* Use the converted disk by manually creating the VM and attaching the disk to it.
+
image:shift-toolkit-image69.png["Figure showing input/output dialog or representing written content"]

NOTE: The Shift toolkit supports disk conversions only for the qcow2 format. It doesn't support VM creation or registration. To use the converted disk, manually create the VM and attach the disk. 

===== Convert to VHDX format

To convert the virtual disks to VHDX format with NetApp Shift toolkit, follow these high-level steps:

* Create a destination site type specifying Hyper-V as the hypervisor.
* Create a resource group with the VMs for which the disk conversion is required
+
image:shift-toolkit-image70.png["Figure showing input/output dialog or representing written content"]
+
image:shift-toolkit-image71.png["Figure showing input/output dialog or representing written content"]

* Create the blueprint to convert the virtual disk to VHDX format. Once the blueprint is created, the preparation jobs will be automatically initiated. 
+
image:shift-toolkit-image72.png["Figure showing input/output dialog or representing written content"]

* Choose "Convert" once the required downtime for the VMs has been scheduled.
+
image:shift-toolkit-image73.png["Figure showing input/output dialog or representing written content"]

* The convert operation executes each operation against the VM and respective disk to generate the appropriate VHDX format.
+
image:shift-toolkit-image74.png["Figure showing input/output dialog or representing written content"]

* Use the converted disk by manually creating the VM and attaching the disk to it.
+
image:shift-toolkit-image75.png["Figure showing input/output dialog or representing written content"]

NOTE: To use the converted VHDX disk in a VM, the VM must be created manually via Hyper-V manager or PowerShell commands, and the disk must be attached to it. Along with this, network should also be mapped manually.

==== Monitoring and Dashboard

Monitor the status of the jobs using Job Monitoring.

image:shift-toolkit-image76.png["Figure showing input/output dialog or representing written content"]

With the intuitive UI, confidently evaluate the status of migration, conversion and blueprints. This enables administrators to swiftly identify successful, failed, or partially failed plans along with the number of VMs migrated or converted.

image:shift-toolkit-image77.png["Figure showing input/output dialog or representing written content"]

==== Advanced Settings

Shift toolkit provides advanced settings that provides which can be accessed by Clicking the Settings icon in the top toolbar.

image:shift-toolkit-image78.png["Figure showing input/output dialog or representing written content"]

===== CredSSP

Shift leverages Credential Security Service Provider (CredSSP) to manage the credentials transfer. During the conversion process, the Shift server runs a number of scripts on the guest OS of the VM being converted. The credentials to run these scripts are passed via a "double-hop" from the Shift server to the guest OS through the Hyper-V server.

image:shift-toolkit-image79.png["Figure showing input/output dialog or representing written content"]

*Configuring the Shift server as a CredSSP client:*

The "Advanced Settings" wizard automatically configures the Shift server as a CredSSP client. Doing so enables the Shift server to delegate credentials to the Hyper-V servers. 

*What happens behind the scenes:*

The Shift toolkit executes a series of commands to configure itself as a client, enabling it to manage Hyper-V hosts. This process involves setting up necessary configurations.

* Runs these commands:
** Set-Item WSMan:\localhost\Client\TrustedHosts -Value "fqdn-of-hyper-v-host"
** Enable-WSManCredSSP -Role client -DelegateComputer "fqdn-of-hyper-v-host"
* Configures the following group policy:
** Computer Configuration > Administrative Templates > System > Credentials Delegation > Allow delegating fresh credentials with NTLM-only server authentication 

Select Enable and add wsman/fqdn-of-hyper-v-host.

*Configuring the Hyper-V server as a CredSSP server*

Use the Enable-WSManCredSSP cmdlet on Hyper-V server to configure the Hyper-V server as a CredSSP server, which enables the Hyper-V server to receive credentials from the Shift server.

On the Hyper-V host where the virtual machines will be provisioned by Shift toolkit server, open a Windows PowerShell session as Administrator and run the following commands:

. Enable-PSRemoting
. Enable-WSManCredSSP -Role server

===== Swagger

The swagger page in the Advanced setting allows interaction with available APIs. The resources available through the Shift toolkit REST API are organized in categories, as displayed on the swagger API documentation page. A brief description of each of the resources with the base resource paths is presented below, along with additional usage considerations where appropriate.

image:shift-toolkit-image80.png["Figure showing input/output dialog or representing written content"]

*Session*

You can use this API to log into the Shift toolkit Server. This API returns a user authorization token that is used to authenticate subsequent requests.

* Start a session
* Validate a session
* Get all session ID
* End a session

*Connector*

* Add a connector
* Get details of all connectors
* Update the connector details by ID
* Get connector details by ID

*Tenant*

Use APIs to perform Add and Get operations

* Add tenant
* Get all tenant

*User*

Use APIs to perform Add, get, change and accept operations

* Add User
* Get all user
* Change password of the user
* Accept EULA

*CredSSP*

Use APIs to perform enable and get operations

* Enable credssp
* Get status of credssp

*Site*

Use APIs to perform get, add, delete and update operations

* Get count of site
* Get all site details
* Add a site
* Get site detail by ID
* Delete a site by ID
* Add virtual environment to a site
* Add storage environment to a site
* Get virtual environment detail for a site
* Update virtual environment detail for a site
* Delete virtual environment detail for a site
* Get storage environment detail for a site
* Update storage environment detail for a site
* Delete storage environment detail for a site

*Discovery*

Use APIs to perform discover and get operations

* Discover source site
* Get all discovery requests for source site
* Discover target site
* Get all discovery requests for target site
* Get discovery steps for source site by Id
* Get discovery steps for target site by Id

*VM*

Use APIs to perform get operations

* Get VMs for a site and virtual environment in source
* Get unprotected VMs for a site and virtual environment
* Get VM count
* Get protected VM count

*Resource*

Use APIs to perform get operations

* Get resource details for a site and virtual environment
* Get source site resources count 
  
*Resource Group*

Use APIs to perform add, update and get operations

* Get protection group count
* Get all protection group details
* Add a protection group
* Get a protection group details by Id
* Delete a protection group by Id
* Update protection group details by Id
* Get VMs of a protection group by Id
* Get Blueprints containing the protection group

*Blueprint*

Use APIs to perform add, update and get operations

* Get Blueprint Count
* Get all Blueprint details
* Add a Blueprint
* Get blueprint details by Id
* Delete blueprint by Id
* Update blueprint details for Id
* Get VMs of a blueprint
* Get power status of VMs present in the blueprint
* Get blueprint Count
* Get all blueprint details

*Compliance*

Use APIs to perform add and get operations

* Get compliance check result for a blueprint
* Get compliance check final status for a blueprint
* Add on demand new compliance check for a blueprint

*Execution*

Use APIs to perform get operations

* Get all execution details
* Get details of execution in progress
* Get execution count
* Get count of executions in progress
* Get steps for execution Id

*Recovery*

Use APIs to perform add and get operations

* Add new execution request for a Blueprint
* Add retry request of execution for a Blueprint
* Get execution statuses of all Blueprints
* Get execution status for Blueprint ID

*Script Block*

Use APIs to perform get and update operations

* Get all scripts metadata
* Get script metadata by Id
* Get all refresh metadata
* Execute script

===== Script block

The script block within in Shift toolkit provides sample code that help automate, integrate and develop features via internal and external APIs available. On the Code Samples section in the script block, browse and download samples written by Shift toolkit Automation team and by the community members. Use the samples to get started with automation, management or integration tasks.

image:shift-toolkit-image81.png["Figure showing input/output dialog or representing written content"]

Here is an example of a sample powershell script which can be used to delete a specific job within Shift UI. The capability is not exposed via workflow, however the same can accomplished via the script block. The same script is also available as a bat script that can executed easily by downloading and calling the same.

image:shift-toolkit-image82.png["Figure showing input/output dialog or representing written content"]

The objective here is to provide sample scripts to perform day 0 and day N operations for specific hypervisors using the Shift toolkit APIs and the respective hypervisor published APIs. 

==== SAN Environments

As a key requirements of Shift toolkit, the VMs to be converted must reside in a NAS environment (NFS for ESX). If the VMs reside in a SAN environment (iSCSI, FC, FCoE, NVMeFC), then they must be migrated to a NAS environment before conversion.

image:shift-toolkit-image83.png["Figure showing input/output dialog or representing written content"]

The approach above depicts a typical SAN environment in which VMs are stored in a SAN datastore. The VMs to be converted from ESX to Hyper-V along with their disks are first migrated to an NFS data-store with VMware vSphere Storage vMotion. Shift toolkit uses FlexClone to convert the VMs from ESX to Hyper-V. The converted VMs (along with their disks) reside on a CIFS share. The converted VMs (along with their disks) are migrated back to the SAN enabled CSV with Hyper-V Storage Live Migration.

NOTE: The live VM migration might fail if nodes have different process capability sets. This can be handled by setting “Migrate to a physical computer with a different processor”. This script is available under script block.

== Conclusion

NetApp Shift toolkit helps an administrator to rapidly and seamlessly convert VMs from VMware to Hyper-V. It can also convert just the virtual disks between the different hypervisors. Therefore, Shift toolkit saves you several hours of effort each time that you want to move workloads from one hypervisor to the other. Organizations can now host multi-hypervisor environments without having to worry about whether workloads are tied down to a single hypervisor. This capability increases flexibility and reduces licensing costs, lock-in, and commitments to a single vendor. 

== Next Steps

Unlock the potential with Data ONTAP by downloading Shift toolkit package and start migrating or converting the virtual machines or the disk files to simplify and streamline migrations.

To learn more about this process, feel free to follow the detailed walkthrough: 

video::dc0d9627-0399-45d9-a843-b1d8010fff80[panopto, title="Shift Toolkit walkthrough", width=360]

== Troubleshooting and Known Issues

. Trigger script for setting IP address and removal VMware tools fails for Windows VM with the following error: The credential is invalid
+
[source, cli]
....
Error message:

Enter-PSSession : The credential is invalid.

Potential causes:

The guest credentials couldn't be validated 

a. The supplied credentials were incorrect
b. There are no user accounts in the guest 
....

. Windows virtual machine encounters BSOD errors
+
*NOTE:* This is not a Shift toolkit problem, however environment related.
+
[source, cli]
....
Error message:

Bluescreen error during initial boot after migration.

Potential cause:

Local group policy setup to block the installation of applications including new drivers for Microsoft Hyper-V. 

a. Update the policy to allow installation of drivers.
....

. No datastores listed while trying to create a resource group
+
[source, cli]
....
Error message:

Mount paths are empty while getting volumes for mountpaths for site.

Potential causes:

The NFS volume used as a datastore is using v4.1 

a. Shift toolkit filters out NFS v3 datastores during the resource group creation. NFS 4.1 or 4.2 is not supported in the current release.
....

. Unable to access Shift toolkit UI after enabling SSL.
+
[source, cli]
....
Error message:

Login failed, Network error

Potential causes:

MongoDB service not running
Using Firefox browser to access Shift UI 

a. Ensure Mongo service is running
b. Use Google Chrome or IE to access Shift UI.
....

== Appendix

=== Custom ONTAP role for Shift toolkit

Create an ONTAP role with minimum privileges so that there is no need to use the ONTAP admin role to perform operations in Shift toolkit. These minimum roles are required at the SVM level on the ONTAP Storage Side.

NOTE: vsadmin can also be used.

image:shift-toolkit-image84.png["Figure showing input/output dialog or representing written content"]

Use ONTAP System Manager to create the role.

Perform the following steps in ONTAP System Manager:

*Create a custom role:*

* To create a custom role at the SVM level, select Storage > Storage VMs > required SVM> Settings > Users and Roles.
* Select the arrow icon (→) next to Users and Roles.
* Select +Add under Roles.
* Define the rules for the role and click Save.

*Map the role to the Shift toolkit user:*

Perform the following steps on the Users and Roles page:

* Select Add icon + under Users.
* Select the required username and select the role created in the previous step in the drop-down menu for Role.
* Click Save.

Once done, use the above created user while configuring the source and destination sites within Shift toolkit UI.

=== Minimum permissions role required on VMware

To migrate virtual machines from VMware vSphere using Shift toolkit, create a RBAC user with the below mentioned privileges using  Administration > Access Control > Roles. 

image:shift-toolkit-image85.png["Figure showing input/output dialog or representing written content"]
