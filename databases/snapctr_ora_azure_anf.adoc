---
sidebar: sidebar
permalink: databases/snapctr_ora_azure_anf.html
keywords: Database, Oracle, Azure, ANF, Ansible, Automation
summary: "The solution provides overview and details for automated Oracle deployment in Microsoft Azure NetApp Files as primary database storage with NFS protocol and Oracle database is deployed as container database with dNFS enabled. Database deployed in Azure is protected using SnapCenter UI tool for simplified database management" 
---

= TR-4988: Oracle Database Backup, Recovery, and Clone on ANF with SnapCenter
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./../media/

Allen Cao, Niyaz Mohamed, NetApp

[.lead]
== Purpose

NetApp SnapCenter software is an easy-to-use enterprise platform to securely coordinate and manage data protection across applications, databases, and file systems. It simplifies backup, restore, and clone lifecycle management by offloading these tasks to application owners without sacrificing the ability to oversee and regulate activity on the storage systems. By leveraging storage-based data management, it enables increased performance and availability, as well as reduced testing and development times.

In TR-4987, link:https://docs.netapp.com/us-en/netapp-solutions/databases/automation_ora_anf_nfs.html[Simplified, Automated Oracle Deployment on Azure NetApp Files with NFS^], we demonstrated automated Oracle deployment in Azure cloud, in this documentation we showcase Oracle database protection and management on Azure NetApp Files (ANF) in Azure cloud with a very user-friendly SnapCenter UI interface. 

This solution addresses the following use cases:

* Backup and recovery of Oracle database deployed on ANF in Azure cloud with SnapCenter  
* Manage database snapshot and clone copies to accelerate application development and improve data lifecycle management

== Audience

This solution is intended for the following people:

* A DBA who would like to deploy Oracle on Azure NetApp Files.
* A database solution architect who would like to test Oracle workloads on Azure NetApp Files.
* A storage administrator who would like to deploy and manage an Oracle database on Azure NetApp Files.
* An application owner who would like to stand up an Oracle database on Azure NetApp Files.

== Solution test and validation environment

The testing and validation of this solution were performed in a lab setting that might not match the final deployment environment. See the section <<Key Factors for Deployment Consideration>> for more information. 

=== Architecture

image::automation_ora_anf_nfs_archit.png["This image provides a detailed picture of the Oracle deployment configuration in AWS public cloud with iSCSI and ASM."]

=== Hardware and software components

[width=100%,cols="33%, 33%, 33%", frame=none, grid=rows]
|===
3+^| *Hardware*
| Azure NetApp Files | Current offering in Azure by Microsoft | One capacity pool with Premium service level 
| Azure VM for DB server | Standard_B4ms - 4 vCPUs, 16GiB | Two Linux virtual machine instances for concurrent deployment 
| Azure VM for SnapCenter | Standard_B4ms - 4 vCPUs, 16GiB | One Windows virtual machine instance 

3+^| *Software*
| RedHat Linux | RHEL Linux 8.6 (LVM) - x64 Gen2 | Deployed RedHat subscription for testing
| Windows Server | 2022 DataCenter; Azure Edition Hotpatch - x64 Gen2 | Hosting SnapCenter server 
| Oracle Database | Version 19.18 | Applied RU patch p34765931_190000_Linux-x86-64.zip
| Oracle OPatch | Version 12.2.0.1.36 | Latest patch p6880880_190000_Linux-x86-64.zip
| SnapCenter Server | Version 5.0 | Workgroup deployment 
| Open JDK | Version java-11-openjdk | SnapCenter plugin requirement on DB VMs 
| NFS | Version 3.0 | Oracle dNFS enabled
| Ansible | core 2.16.2 | Python 3.6.8
|===

=== Oracle database configuration in the lab environment

[width=100%,cols="33%, 33%, 33%", frame=none, grid=rows]
|===
3+^| 
| *Server* | *Database* | *DB Storage*
| ora-01 | NTAP1(NTAP1_PDB1,NTAP1_PDB2,NTAP1_PDB3) | /u01, /u02, /u03 NFS mounts on ANF capacity pool
| ora-02 | NTAP2(NTAP2_PDB1,NTAP2_PDB2,NTAP2_PDB3) | /u01, /u02, /u03 NFS mounts on ANF capacity pool
|===

=== Key factors for deployment consideration

* *SnapCenter deployment.* SnapCenter can deploy in a Windows domain or Workgroup environment. For domain-based deployment, the domain user account should be a domain administrator account, or the domain user belongs to the local administrator's group on the SnapCenter hosting server.    

* *Name resolution.* SnapCenter server needs to resolve the name to the IP address for each managed target database server host. Each target database server host must resolve the SnapCenter server name to the IP address. If a DNS server is unavailable, add naming to local host files for resolution.  

* *Resource group configuration.* Resource group in SnapCenter is a logical grouping of similar resources that can be backed up together. Thus, it simplifies and reduces the number of backup jobs in a large database environment. 

* *Separate full database and archive log backup.* Full database backup includes data volumes and log volumes consistent group snapshots. A frequent full database snapshot incurs higher storage consumption but improves RTO. An alternative is less frequent full database snapshots and more frequent archive logs backup, which consumes less storage and improves RPO but may extend RTO. Consider your RTO and RPO objectives when setting up the backup scheme. There is also a limit (1023) on the number of snapshot backups on a volume.

* *Privilege delegation.* Leverage role based control that is built-in within SnapCenter UI to delegate privileges to application and database teams if desired. 
  
== Solution deployment

The following sections provide step-by-step procedures for SnapCenter deployment, configuration, and Oracle database backup, recovery, and clone on Azure NetApp Files in the Azure cloud.  

=== Prerequisites for deployment
[%collapsible]
====

Deployment requires existing Oracle databases running on ANF in Azure. If not, follow the steps below to create two Oracle databases for solution validation. For details of Oracle database deployment on Azure with automation, referred to TR-4987: link:https://docs.netapp.com/us-en/netapp-solutions/databases/automation_ora_anf_nfs.html[Simplified, Automated Oracle Deployment on Azure NetApp Files with NFS^]  

. An Azure account has been set up, and the necessary VNet and network segments have been created within your Azure account.

. From the Azure cloud portal, deploy Azure Linux VMs as Oracle DB servers. Create an Azure NetApp Files capacity pool and database volumes for Oracle database. Enable VM SSH private/public key authentication for azureuser to DB servers. See the architecture diagram in the previous section for details about the environment setup. Also referred to link:https://docs.netapp.com/us-en/netapp-solutions/databases/azure_ora_nfile_procedures.html[Step-by-Step Oracle deployment procedures on Azure VM and Azure NetApp Files^] for detailed information.
+
[NOTE]

For Azure VMs deployed with local disk redundancy, ensure that you have allocated at least 128G in the VM root disk to have sufficient space to stage Oracle installation files and add OS swap file. Expand /tmplv and /rootlv OS partition accordingly. Ensure the database volume naming follows the VMname-u01, VMname-u02, and VMname-u03 convention.
+
[source, cli]
sudo lvresize -r -L +20G /dev/mapper/rootvg-rootlv
+
[source, cli]
sudo lvresize -r -L +10G /dev/mapper/rootvg-tmplv

. From the Azure cloud portal, provision a Windows server to run the NetApp SnapCenter UI tool with the latest version. Refer to the following link for details: link:https://docs.netapp.com/us-en/snapcenter/install/task_install_the_snapcenter_server_using_the_install_wizard.html[Install the SnapCenter Server^]. 

. Provision a Linux VM as the Ansible controller node with the latest version of Ansible and Git installed. Refer to the following link for details: link:https://docs.netapp.com/us-en/netapp-solutions/automation/getting-started.html[Getting Started with NetApp solution automation^] in section - 
`Setup the Ansible Control Node for CLI deployments on RHEL / CentOS` or 
`Setup the Ansible Control Node for CLI deployments on Ubuntu / Debian`. 
+
[NOTE]

The Ansible controller node can locate either on-premisses or in Azure cloud as far as it can reach Azure DB VMs via ssh port.  

. Clone a copy of the NetApp Oracle deployment automation toolkit for NFS. Follow instructions in link:https://docs.netapp.com/us-en/netapp-solutions/databases/automation_ora_anf_nfs.html[TR-4887^] to execute the playbooks.
+
[source, cli]
git clone https://bitbucket.ngage.netapp.com/scm/ns-bb/na_oracle_deploy_nfs.git

. Stage following Oracle 19c installation files on Azure DB VM /tmp/archive directory with 777 permission.
+
      installer_archives:
        - "LINUX.X64_193000_db_home.zip"
        - "p34765931_190000_Linux-x86-64.zip"
        - "p6880880_190000_Linux-x86-64.zip"


. Watch the following video:
+
video::960fb370-c6e0-4406-b6d5-b110014130e8[panopto, title="Oracle Database Backup, Recovery, and Clone on ANF with SnapCenter", width=360]

. Review the `Get Started` online menu.
+

====

=== SnapCenter installation and setup
[%collapsible]


====

We recommend to go through online SnapCenter software documentation before proceeding to SnapCenter installation and configuration: link:https://docs.netapp.com/us-en/snapcenter/index.html[SnapCenter Software documentation^]. Following provides a high level summary of steps for installation and setup of SnapCenter software for Oracle on Azure ANF. 

. From SnapCenter Windows server, download and install latest java JDK from link:https://www.java.com/en/[Get Java for desktop applications^].

. From SnapCenter Windows server, download and install latest version (currently 5.0) of SnapCenter installation executable from NetApp support site: link:https://mysupport.netapp.com/site/[NetApp | Support^].

. After SnapCenter server installation, launch browser to login to SnapCenter with Windows local admin user or domain user credential via port 8146.
+
image::snapctr_ora_azure_anf_setup_01.png["This image provides login screen for SnapCenter server"]

. Review `Get Started` online menu.
+
image::snapctr_ora_azure_anf_setup_02.png["This image provides online menu for SnapCenter server"]

. In `Settings-Global Settings`, check `Hypervisor Settings` and click on Update.
+
image::snapctr_ora_azure_anf_setup_03.png["This image provides Hypervisor Settings for SnapCenter server"] 

. If needed, adjust `Session Timeout` to the desired interval.
+
image::snapctr_ora_azure_anf_setup_04.png["This image provides Session Timeout for SnapCenter server"]

. Add additional users to SnapCenter if needed.
+
image::snapctr_ora_azure_anf_setup_06.png["This image provides Settings-Users and Access for SnapCenter server"]

. Roles tab list the built-in roles that can be assigned to different SnapCenter users. Custom roles also can be created by admin user with desired privileges.
+
image::snapctr_ora_azure_anf_setup_07.png["This image provides Roles for SnapCenter server"] 

. From `Settings-Credential`, create credentials for SnapCenter management targets. In this demo use case, they are linux user for login to Azure VM and ANF credential for capacity pool access.
+
image::snapctr_ora_azure_anf_setup_08.png["This image provides Credentials for SnapCenter server"]
image::snapctr_ora_azure_anf_setup_09.png["This image provides Credentials for SnapCenter server"]
image::snapctr_ora_azure_anf_setup_10.png["This image provides Credentials for SnapCenter server"] 

. From `Storage Systems` tab, add `Azure NetApp Files` with credential created above.
+
image::snapctr_ora_azure_anf_setup_11.png["This image provides Azure NetApp Files for SnapCenter server"]
image::snapctr_ora_azure_anf_setup_12.png["This image provides Azure NetApp Files for SnapCenter server"]

. From `Hosts` tab, add Azure DB VMs, which installs SnapCenter plugin for Oracle on Linux.
+
image::snapctr_ora_azure_anf_setup_13.png["This image provides Hosts for SnapCenter server"]
image::snapctr_ora_azure_anf_setup_14.png["This image provides Hosts for SnapCenter server"]
image::snapctr_ora_azure_anf_setup_15.png["This image provides Hosts for SnapCenter server"]

. Once host plugin is installed on DB server VM, databases on the host are auto discovered and visible in `Resources` tab. Back to `Settings-Polices`, create backup policies for full Oracle database online backup and archive logs only backup. Refer to this document link:https://docs.netapp.com/us-en/snapcenter/protect-sco/task_create_backup_policies_for_oracle_database.html[Create backup policies for Oracle databases^] for detailed step by step procedures.
+
image::snapctr_ora_azure_anf_setup_05.png["This image provides Settings-Policies for SnapCenter server"] 
====

=== Database backup
[%collapsible]

====

. Ansible target `hosts` file configuration:
+
include::../_include/automation_ora_anf_nfs_hosts.adoc[]

. Global `vars/vars.yml` file configuration
+
include::../_include/automation_ora_anf_nfs_vars.adoc[]

. Local DB server `host_vars/host_name.yml` configuration such as ora_01.yml, ora_02.yml ...
+
include::../_include/automation_ora_asa_iscsi_host_vars.adoc[]

====

=== Database recovery
[%collapsible]

====

There are a total of five playbooks in the automation toolkit. Each performs different task blocks and serves different purposes.

      0-all_playbook.yml - execute playbooks from 1-4 in one playbook run.
      1-ansible_requirements.yml - set up Ansible controller with required libs and collections.
      2-linux_config.yml - execute Linux kernel configuration on Oracle DB servers.
      4-oracle_config.yml - install and configure Oracle on DB servers and create a container database. 
      5-destroy.yml - optional to undo the environment to dismantle all. 

There are three options to run the playbooks with the following commands. 

. Execute all deployment playbooks in one combined run.
+
[source, cli]
ansible-playbook -i hosts 0-all_playbook.yml -u azureuser -e @vars/vars.yml

. Execute playbooks one at a time with the number sequence from 1-4.
+
[source, cli]] 
ansible-playbook -i hosts 1-ansible_requirements.yml -u azureuser -e @vars/vars.yml
+
[source, cli] 
ansible-playbook -i hosts 2-linux_config.yml -u azureuser -e @vars/vars.yml
+
[source, cli]
ansible-playbook -i hosts 4-oracle_config.yml -u azureuser -e @vars/vars.yml

. Execute 0-all_playbook.yml with a tag.
+
[source, cli]
ansible-playbook -i hosts 0-all_playbook.yml -u azureuser -e @vars/vars.yml -t ansible_requirements
+
[source, cli]
ansible-playbook -i hosts 0-all_playbook.yml -u azureuser -e @vars/vars.yml -t linux_config
+
[source, cli]
ansible-playbook -i hosts 0-all_playbook.yml -u azureuser -e @vars/vars.yml -t oracle_config

. Undo the environment
+
[source, cli]
ansible-playbook -i hosts 5-destroy.yml -u azureuser -e @vars/vars.yml


====

=== Database clone
[%collapsible]

====




====


== Where to find additional information

To learn more about the information described in this document, review the following documents and/or websites:

* Azure NetApp Files
+
link:https://azure.microsoft.com/en-us/products/netapp[https://azure.microsoft.com/en-us/products/netapp^]


* SnapCenter Software documentation
+
link:https://docs.netapp.com/us-en/snapcenter/index.html[https://docs.netapp.com/us-en/snapcenter/index.html^]


* TR-4987: Simplified, Automated Oracle Deployment on Azure NetApp Files with NFS
+
link:https://docs.netapp.com/us-en/netapp-solutions/databases/automation_ora_anf_nfs.html[https://docs.netapp.com/us-en/netapp-solutions/databases/automation_ora_anf_nfs.html^]






