---
sidebar: sidebar
permalink: databases/azure_ora_nfile_procedures.html
summary: This section describes the deployment procedures of deploying Oracle RDS custom database with FSx storage.
keywords: AWS, Oracle, RDS, HA, DR, database
---

= Step-by-Step Oracle Deployment Procedures on Azure VM and Azure NetApp Files (ANF)
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:table-stripes: odd
:imagesdir: ./../media/

link:azure_ora_nfile_factors.html[Previous: Factors to consider.]

== Deploy an Azure VM with ANF for Oracle via Azure portal console

If you are new to Azure, you first need to set up an Azure account environment. This includes to sign up your organization to use Azure Active Directory. The following section is a summary of these steps. For details, see the linked Azure specific documentation.

=== Create and consume Azure resources

After your Azure environment is setup and an account is created and associated to a subscription, you can login to Azure portal with the account to create necessary resources to run Oracle.

==== 1. Create a virtual network or VNet

Azure Virtual Network (VNet) is the fundamental building block for your private network in Azure. VNet enables many types of Azure resources, such as Azure Virtual Machines (VM), to securely communicate with each other, the internet, and on-premises networks. Before Provisioning a Azure virtual machine, a VNet, where VM is deployed into, needs to be configured first.

Follow this documentation link:https://docs.microsoft.com/en-us/azure/virtual-network/quick-create-portal[Create a virtual network using the Azure portal^] to create a VNet.

==== 2. Create a NetApp storage account and a capacity pool for ANF

In this deployment scenario, an Azure VM OS is provisioned using regular Azure storage but ANF volumes are provisioned to run Oracle database via NFS. First, you need to create a NetApp storage account and a capacity pool to host the storage volumes.

Follow this documentation link:https://docs.microsoft.com/en-us/azure/azure-netapp-files/azure-netapp-files-quickstart-set-up-account-create-volumes?tabs=azure-portal[Set up Azure NetApp Files and create an NFS volume^] to setup ANF capacity pool.

==== 3. Provision Azure virtual machine for Oracle

Based on your workload, first determine what type of Azure VM and the size of VM in terms of vCPU and RAM to deploy for Oracle. Then from Azure console, click on Virtual machine icon to launch VM deployment workflow.

. From Azure Virtual machine page, click "Create", then choose Azure virtual machine.
+
image:db_ora_azure_anf_vm_01.PNG[Error: Missing Graphic Image]

. Choose the subscription ID for the deployment, any resource group, region, host name, VM image, size, authentication method. Then, go to "Disk" page.
+
image:db_ora_azure_anf_vm_02-1.PNG[Error: Missing Graphic Image]
image:db_ora_azure_anf_vm_02-2.PNG[Error: Missing Graphic Image]

. Choose premium SSD for OS local redundancy and leave data disk black. the data disks will be mounted from ANF storage instead. Then, go to "Networking page".
+
image:db_ora_azure_anf_vm_03.PNG[Error: Missing Graphic Image]

. Choose VNet and subnet. Allocate a public IP for external VM access. Then, go to "Management page".
+
image:db_ora_azure_anf_vm_04.PNG[Error: Missing Graphic Image]

. Keep all default for Management and move to "Advanced" page.
+
image:db_ora_azure_anf_vm_05.PNG[Error: Missing Graphic Image]

. Keep all default for Advanced page unless you need to customized VM after deployment with custom scripts. Then, go to "Tags" page.
+
image:db_ora_azure_anf_vm_06.PNG[Error: Missing Graphic Image]

. Add a tag for the VM if desired. Then, go to "Review + create" page.
+
image:db_ora_azure_anf_vm_07.PNG[Error: Missing Graphic Image]

. Deployment work flow runs a validation on the configuration, if passed, click on "Create" button to create the VM.
+
image:db_ora_azure_anf_vm_08.PNG[Error: Missing Graphic Image]

==== 4. Provision ANF database volumes for Oracle

You will need to create three NFS volumes off ANF capacity pool for Oracle binary, data, and log volumes respectively.

. From Azure console, under the list of Azure services, click on Azure NetApp Files to open volume creation workflow. If you have more than one ANF storage accounts, click on the account that you intend to provision volumes from.
+
image:db_ora_azure_anf_vols_00.PNG[Error: Missing Graphic Image]

. Under NetApp storage account, click on Volumes, then Add volume to create Oracle volumes.
+
image:db_ora_azure_anf_vols_01_1.PNG[Error: Missing Graphic Image]
image:db_ora_azure_anf_vols_01.PNG[Error: Missing Graphic Image]

. As a good practice, identify Oracle volumes with VM host name as a prefix and follow by mount point on the host such as u01 for Oracle binary, u02 for Oracle data, and u03 for Oracle log. Choose the same VNet for the volume as the VM. Then, click "Next: Protocol>".
+
image:db_ora_azure_anf_vols_02.PNG[Error: Missing Graphic Image]

. Choose NFS protocol, add Oracle host IP address to the allowed client and remove the default policy that allow all IP addresses 0.0.0.0/0. Then, click "Next: Tags>".
+
image:db_ora_azure_anf_vols_03.PNG[Error: Missing Graphic Image]

. Add a volume tag if desired. Then, click "Review + Create>".
+
image:db_ora_azure_anf_vols_04.PNG[Error: Missing Graphic Image]

. If validation passes, click "Create" button to create the volume.
+
image:db_ora_azure_anf_vols_05.PNG[Error: Missing Graphic Image]


== Install and configure Oracle on Azure virtual machine with ANF

NetApp solutions team has built many Ansible based automation tool kits to help you deploy Oracle in Azure smoothly. Follow these steps to deploy Oracle on Azure VM:

=== Setup a Ansible controller

If you have not setup a Ansible controller, go through this documentation link:https://docs.netapp.com/us-en/netapp-solutions/automation/automation_introduction.html[NetApp Solution Automation^], which has detailed instructions on how to setup an Ansible controller.

=== Obtain Oracle deployment automation toolkit

Clone a copy of Oracle deployment tool kit in home directory under the user ID that you use to login to Ansible controller.

[source, cli]
git clone https://github.com/NetApp-Automation/na_oracle19c_deploy.git

=== Execute the toolkit with your configuration

Follow this instruction link:https://docs.netapp.com/us-en/netapp-solutions/databases/cli_automation.html#cli-deployment-oracle-19c-database[CLI deployment Oracle 19c Database^] to execute the playbook via CLI. You can ignore the ONTAP portion of variables configuration in global VARS file as you create database volumes from Azure console rather than CLI.

[NOTE]

The toolkit default deploys Oracle 19c with RU 19.8. It can be easily adapted for any other patch level with minor default configuration change. Also default seed database active log files are deployed into data volume. If you need active log files on log volume, it should be relocated after initial deployment. Reach out to NetApp Solution team for help if needed.

== Setup AzAcSnap backup tool for app consistent snapshot for Oracle

Azure Application Consistent Snapshot tool (AzAcSnap) is a command-line tool that enables data protection for third-party databases by handling all the orchestration required to put them into an application consistent state before taking a storage snapshot, after which it returns them to an operational state.

It is recommended that the tool is installed on the database server host. Following are installation and configuration procedures.

=== Install AzAcSnap tool

. Get the most recent version of link:https://aka.ms/azacsnapinstaller[the AzArcSnap Installer^].

. Copy the downloaded self-installer to the target system.

. Execute the self-installer as the root user, with default installation option. If necessary, make the file executable using the chmod +x *.run command.
+
[source, cli]
 ./azacsnap_installer_v5.0.run -I

=== Configure Oracle connectivity

The snapshot tools communicate with the Oracle database and need a database user with appropriate permissions to enable/disable backup mode.

==== 1. Setup AzAcSnap database user

The following examples show the set up of the Oracle database user, the use of sqlplus for communication to the Oracle database. The example commands set up a user (AZACSNAP) in the Oracle database, change the IP address, usernames, and passwords as appropriate:

. From the Oracle database installation, launch sqlplus to login to database.
+
[source, cli]
su – oracle
sqlplus / AS SYSDBA

. Create the user
+
[source, cli]
CREATE USER azacsnap IDENTIFIED BY password;

. Grant the user permissions - This example sets the permission for the AZACSNAP user to allow for putting the database in backup mode.
+
[source, cli]
GRANT CREATE SESSION TO azacsnap;
GRANT SYSBACKUP TO azacsnap;

. Change default user's password expiration to unlimited
+
[source, cli]
ALTER PROFILE default LIMIT PASSWORD_LIFE_TIME unlimited;

. Validate azacsnap connectivity to database
+
[source, cli]
connect azacsnap/password
quit;

==== 2. Configure Linux user azacsnap for DB access with Oracle wallet

The AzAcSnap default installation will create an azacsnap OS user. Its bash shell environment needs configured for Oracle database access with password stored in an Oracle wallet.

. As root user cat /etc/oratab to find out ORACLE_HOME and ORACLE_SID variables on the host
+
[source, cli]
cat /etc/oratab

. Add ORACLE_HOME, ORACLE_SID, TNS_ADMIN, PATH variables to azacsnap user bash profile. Change to appropriate variables as needed.
+
[source, cli]
echo "export ORACLE_SID=ORATEST" >> /home/azacsnap/.bash_profile
echo "export ORACLE_HOME=/u01/app/oracle/product/19800/ORATST" >> /home/azacsnap/.bash_profile
echo "export TNS_ADMIN=/home/azacsnap" >> /home/azacsnap/.bash_profile
echo "export PATH=\$PATH:\$ORACLE_HOME/bin" >> /home/azacsnap/.bash_profile

. As the Linux user azacsnap, create the wallet, you will be prompted for wallet password.
+
[source, cli]
sudo su - azacsnap
+
[source, cli]
mkstore -wrl $TNS_ADMIN/.oracle_wallet/ -create

. Add the connect string credentials to the Oracle Wallet. In the following example command: AZACSNAP is the ConnectString to be used by AzAcSnap; azacsnap is the Oracle Database User; AzPasswd1 is the Oracle User's database password. You will be again prompted for wallet password.
+
[source, cli]
mkstore -wrl $TNS_ADMIN/.oracle_wallet/ -createCredential AZACSNAP azacsnap AzPasswd1

. Create the tnsnames-ora file. In the following example command: HOST should be set to the IP address of the Oracle Database Server; SID should be set to the Oracle Database SID.
+
[source, cli]
echo "# Connection string
AZACSNAP=\"(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=172.30.137.142)(PORT=1521))(CONNECT_DATA=(SID=ORATST)))\"
" > $TNS_ADMIN/tnsnames.ora

. Create sqlnet.ora file
+
[source, cli]
echo "SQLNET.WALLET_OVERRIDE = TRUE
WALLET_LOCATION=(
    SOURCE=(METHOD=FILE)
    (METHOD_DATA=(DIRECTORY=\$TNS_ADMIN/.oracle_wallet))
) " > $TNS_ADMIN/sqlnet.ora

. Test Oracle access using wallet
+
[source, cli]
sqlplus /@AZACSNAP as SYSBACKUP
+
The expected output from the command:
[azacsnap@acao-ora01 ~]$ sqlplus /@AZACSNAP as SYSBACKUP
+
SQL*Plus: Release 19.0.0.0.0 - Production on Thu Sep 8 18:02:07 2022
Version 19.8.0.0.0
+
Copyright (c) 1982, 2019, Oracle.  All rights reserved.
+

Connected to:
Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production
Version 19.8.0.0.0
+
SQL>

=== Configure ANF connectivity

This section explains how to enable communication with Azure NetApp Files (with Virtual machine).

. Within an Azure Cloud Shell session, make sure you're logged on at the subscription where you want to be associated with the service principal by default:
+
[source, cli]
az account show

. If the subscription isn't correct, use the following command:
+
[source, cli]
az account set -s <subscription name or id>

. Create a service principal using Azure CLI per the following example:
+
[source, cli]
az ad sp create-for-rbac --name "AzAcSnap" --role Contributor --scopes /subscriptions/{subscription-id} --sdk-auth
+
The expected output:
+
{
  "clientId": "00aa000a-aaaa-0000-00a0-00aa000aaa0a",
  "clientSecret": "00aa000a-aaaa-0000-00a0-00aa000aaa0a",
  "subscriptionId": "00aa000a-aaaa-0000-00a0-00aa000aaa0a",
  "tenantId": "00aa000a-aaaa-0000-00a0-00aa000aaa0a",
  "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",
  "resourceManagerEndpointUrl": "https://management.azure.com/",
  "activeDirectoryGraphResourceId": "https://graph.windows.net/",
  "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",
  "galleryEndpointUrl": "https://gallery.azure.com/",
  "managementEndpointUrl": "https://management.core.windows.net/"
}

. Cut and Paste the output content into a file called oracle.json stored in Linux user azacsnap user bin directory and secure the file with appropriate system permissions.

[NOTE]

Make sure the format of the JSON file is exactly as described above. Especially with the URLs enclosed in double quotes (").

=== Complete the setup of AzAcSnap tool

Follow these steps to configure and test the snapshot tools. After successful testing, then perform the first database consistent storage snapshot.

. Change into the snapshot user account
+
[source, cli]
su - azacsnap

. Change to location of commands
+
[source, cli]
cd /home/azacsnap/bin/

. Configure a storage backup detail file. This would create a azacsnap.json configuration file.
+
[source, cli]
azacsnap -c configure –-configuration new
+
The expected output with 3 Oracle volumes:
+
[azacsnap@acao-ora01 bin]$ azacsnap -c configure --configuration new
Building new config file
Add comment to config file (blank entry to exit adding comments): Oracle snapshot bkup
Add comment to config file (blank entry to exit adding comments):
Enter the database type to add, 'hana', 'oracle', or 'exit' (for no database): oracle
+
=== Add Oracle Database details ===
Oracle Database SID (e.g. CDB1): ORATST
Database Server's Address (hostname or IP address): 172.30.137.142
Oracle connect string (e.g. /@AZACSNAP): /@AZACSNAP
+
=== Azure NetApp Files Storage details ===
Are you using Azure NetApp Files for the database? (y/n) [n]: y
--- DATA Volumes have the Application put into a consistent state before they are snapshot ---
Add Azure NetApp Files resource to DATA Volume section of Database configuration? (y/n) [n]: y
Full Azure NetApp Files Storage Volume Resource ID (e.g. /subscriptions/.../resourceGroups/.../providers/Microsoft.NetApp/netAppAccounts/.../capacityPools/Premium/volumes/...): /subscriptions/0efa2dfb-917c-4497-b56a-b3f4eadb8111/resourceGroups/ANFAVSRG/providers/Microsoft.NetApp/netAppAccounts/ANFAVSAcct/capacityPools/CapPool/volumes/acao-ora01-u01
Service Principal Authentication filename or Azure Key Vault Resource ID (e.g. auth-file.json or https://...): oracle.json
Add Azure NetApp Files resource to DATA Volume section of Database configuration? (y/n) [n]: y
Full Azure NetApp Files Storage Volume Resource ID (e.g. /subscriptions/.../resourceGroups/.../providers/Microsoft.NetApp/netAppAccounts/.../capacityPools/Premium/volumes/...): /subscriptions/0efa2dfb-917c-4497-b56a-b3f4eadb8111/resourceGroups/ANFAVSRG/providers/Microsoft.NetApp/netAppAccounts/ANFAVSAcct/capacityPools/CapPool/volumes/acao-ora01-u02
Service Principal Authentication filename or Azure Key Vault Resource ID (e.g. auth-file.json or https://...): oracle.json
Add Azure NetApp Files resource to DATA Volume section of Database configuration? (y/n) [n]: n
--- OTHER Volumes are snapshot immediately without preparing any application for snapshot ---
Add Azure NetApp Files resource to OTHER Volume section of Database configuration? (y/n) [n]: y
Full Azure NetApp Files Storage Volume Resource ID (e.g. /subscriptions/.../resourceGroups/.../providers/Microsoft.NetApp/netAppAccounts/.../capacityPools/Premium/volumes/...): /subscriptions/0efa2dfb-917c-4497-b56a-b3f4eadb8111/resourceGroups/ANFAVSRG/providers/Microsoft.NetApp/netAppAccounts/ANFAVSAcct/capacityPools/CapPool/volumes/acao-ora01-u03
Service Principal Authentication filename or Azure Key Vault Resource ID (e.g. auth-file.json or https://...): oracle.json
Add Azure NetApp Files resource to OTHER Volume section of Database configuration? (y/n) [n]: n
+
=== Azure Managed Disk details ===
Are you using Azure Managed Disks for the database? (y/n) [n]: n
+
=== Azure Large Instance (Bare Metal) Storage details ===
Are you using Azure Large Instance (Bare Metal) for the database? (y/n) [n]: n
+
Enter the database type to add, 'hana', 'oracle', or 'exit' (for no database): exit
+

Editing configuration complete, writing output to 'azacsnap.json'.

. As azacsnap Linux user, run the azacsnap test command for Oracle backup
+
[source, cli]
cd ~/bin
azacsnap -c test --test oracle --configfile azacsnap.json
+
The expected output:
+
[azacsnap@acao-ora01 bin]$ azacsnap -c test --test oracle --configfile azacsnap.json
BEGIN : Test process started for 'oracle'
BEGIN : Oracle DB tests
PASSED: Successful connectivity to Oracle DB version 1908000000
END   : Test process complete for 'oracle'
[azacsnap@acao-ora01 bin]$

. Run your first snapshot backup
+
[source, cli]
azacsnap -c backup –-volume data --prefix ora_test --retention=1

link:azure_ora_nfile_protection.html[Next: Database protection.]
