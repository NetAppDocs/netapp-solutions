---
sidebar: sidebar
permalink: databases/aws_postgres_fsx_ec2_hadr.html
keywords: PostgreSQL, AWS, "FSx ONTAP", Database, "Open Source Database"
summary: The solution provides overview and details for PostgreSQL database deployment and HA/DR setup, failover, resync based on NetApp SnapMirror technology built into FSx ONTAP storage offering and NetApp Ansible automation toolkit in AWS.  
---

= PostgreSQL High Availability Deployment and Disaster Recovery in AWS FSx/EC2
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
// For the imagesdir setting, make sure the path to the media folder is correct.  The default path assumes
// the source is located in the root of the repository.  Select the appropriate setting based on the level
// of the folder containing the source
:imagesdir: ./../media/
// :imagesdir: ./../media/
// :imagesdir: ./../../media/


[.lead]
Author(s): Allen Cao,  Niyaz Mohamed,  NetApp

== Purpose
// Describe WHAT problem this solution addresses.  What are the use cases(s) and how does it solve a problem?
// Use a bulleted list and keep it brief!

PostgreSQL is one of widely used open source database. It ranked at number four among the top ten most popular database engines by link:https://db-engines.com/en/ranking[DB-engines racking^]. The PostgreSQL popularity derives from license free model as it is open sourced database engine while not lacking sophisticated features. However, because it is open sourced, there is lacking of documentation on production grade database deployment in the area of high availability and disaster recovery (HA/DR) particularly in public cloud. It can be complicated endeavor trying to setup typical PostgreSQL HA/DR with hot/warm standby, streaming replication etc. It can be difficulty to test the HA/DR environment by promoting standby site, then switch back to primary. There are well documented performance issues on the primary while you maintain a streaming hot standby for read workload.   

This solution is built on well known, proven, popular NetApp SnapMirror storage level replication technology available in AWS native FSX ONTAP cloud storage for PostgreSQL HA/DR. It is simple to implement with automation toolkit provided by NetApp Solutions team. It provides similar PostgreSQL application level HA/DR functionalities while eliminating the complexity, performance drag on the primary site of the application level streaming based HA/DR solution. The solution can be easily deployed and tested without any impact to active primary site. 

This solution addresses the following use cases:

* Production grade HA/DR deployment for PostgreSQL in AWS public cloud 
* Test and validate PostgreSQL workload in AWS public cloud

== Audience
// Who is this solution directed at?  DevOps engineer, IT specialist, DB administrator, etc.
// If there are multiple audiences, use a list to identity them.

This solution is intended for the:

* DBA, who is interested in how to deploy PostgreSQL with HA/DR in AWS public cloud
* Database Solution Architect, who is interested in testing PostgreSQL workload in AWS public cloud

== Solution Test / Validation Environment
// Identify the environment in which the solution was tested / validated.

// Things to consider including here are:
// * Architecture diagram
// * Software / hardware and version / release levels or model numbers
// * Specific configuration that might be unique to a lab / test environment

The testing and validation of this solution was performed in AWS FSx and EC2 environment that may or may not match the final deployment environment. For more information, please refer to the section key Factors for Deployment Consideration in following sections.

.Architecture
[%collapsible]
=====

image::aws_postgres_fsx_ec2_architecture.PNG[Solution Architecture Diagram]
=====

.Hardware / Software Components
[%collapsible]
=====
// Identify the hardware and software components along with the appropriate hardware level or software versions
// Use the 3rd column if there is a related link that can be provided for more information

[%autowidth.stretch]
|===
3+^| *Hardware*
| FSx ONTAP Storage | Current Version | Two FSx HA pairs in same VPC and availability zone as primary and standby HA clusters
| EC2 Instance for Compute | t2.xlarge/4vCPU/16G | Two EC2 T2 xlarge as primary and standby compute instances
| Ansible Controller | on-prem Centos VM/4vCPU/8G | A VM to host Ansible automation controller either on-prem or cloud  

3+^| *Software*
| RedHat Linux | RHEL-8.6.0_HVM-20220503-x86_64-2-Hourly2-GP2 | Deployed RedHat subscription for testing
| Centos Linux | CentOS Linux release 8.2.2004 (Core) | Hosting Ansible controller deployed in on-prem lab
| PostgreSQL | Version 14.5 | Automation will pull the latest available version of PostgreSQL from postgresql.ora yum repo  
| Ansible | Version 2.10.3 | Prerequisites for required collections and libs installed with requirements playbook  
|===
=====

.Key Factors for Deployment Consideration
[%collapsible]
=====
// Identify anything that might differ in a production environment that was different in a lab environment or assumptions that were made

* EC2 Compute Instances
  In the tests and validations, we have used AWS EC2 t2.xlarge instance type as PostgreSQL database compute instance. It is recommended that in actual deployment, M5 type EC2 instance should be used as compute instance for PostgreSQL as it is optimized for database workload. 

* FSx Storage HA Clusters
  In the tests and validations, we have deployed FSx HA cluster in a single AWS availability zone. For production deployment, it is recommended to deploy a FSx HA pair in two different availability zones and disaster recovery standby HA pair for business continuity can be setup in different regions if certain physical distance between primary and standby is a requirement. 

* PostgreSQL Data and Log Placement
  Typical PostgreSQL deployment share the same root directory or volumes for data and log files. In our tests and validations, we have separated PostgreSQL data and logs into two separate volumes for performance. A soft link is used in data directory to point to logs directory or volume, which hosts PostgreSQL WAL logs and archived WAL logs.

* PostgreSQL service startup delay timer 
  The solution utilizes the NFS mounted volumes to store PostgreSQL database file and WAL logs files. During database host reboot, PostgreSQL service may try to start while the volume is not mounted. This will result in database service startup failure. A 10-15 seconds timer delay is needed for the PostgreSQL database to start correctly.

* RPO/RTO for Business Continuity
  FSx data replication from primary to standby for DR is based on ASYNC, which means RPO will depends on the frequency of SnapShot backup and SnapMirror replication. Higher frequency of SnapShot/SnapMirror reduce RPO thus the potential data loss in the event of disaster at the expense of incremental storage cost. It had been validated that SnapShot/SnapMirror replication can be implemented as low as 5 minutes interval and PostgreSQL can generally recovered at DR standby site within under a minute.

* Database backup 
  Once PostgreSQL database is implemented or migrated into AWS FSx storage from on-premisses data center, the data is auto sync mirrored in FSx HA pair for protection. The data protection is further hardened with a replicated standby site in case of a disaster. For longer term backup retention or data protection, it is recommended to use PostgreSQL built-in pg_basebackup utility to run full database backup that can be shipped to S3 blob storage.    

=====

== Solution Deployment
// Describe the steps required to fully deploy the solution.
// Please use collapsible blocks with descriptive titles to condense the content in the published HTML.
// Include screenshots, demo videos, etc. that make the steps as simple and clear as possible.
// DO NOT overdo it with screenshots - where options are "obvious", a screenshot might not be necessary.

The deployment of this solution can be completed automatically using NetApp provided Ansible based automation toolkit following the detailed instruction as outlined below.

. Read the instructions in automation toolkit READme.md link:https://github.com/NetApp-Automation/na_postgresql_aws_deploy_hadr[na_postgresql_aws_deploy_hadr]
. Go over the video walk through below 
. Configure the required parameters files: hosts, host_vars/host_name.yml, fsx_vars.yml by input user specific parameters into template in following relevant sections, then use copy button to copy files to Ansible controller host. 


.Video Walk Through
[%collapsible]
=====
video::aws_postgres_fsx_ec2_deploy_hadr.mp4[]
=====

.Automated Deployment Prerequisites
[%collapsible]
=====
. An AWS account has been setup and necessary VPC and network segments has been setup within your AWS account.

. From AWS EC2 console, deploy two EC2 Linux instances as primary PostgreSQL DB server at primary and and standby DR site. For compute redundancy at primary and standby DR site , deploy two additional EC2 Linux instances as standby PostgreSQL DB servers. Referred to architecture diagram in previous section for details of environment setup.

. From AWS EC2 console, deploy two FSx ONTAP storage HA clusters to host PostgreSQL database volumes. If you are not familiar with deployment of FSx storage. Referred to following section -  AWS FSx ONTAP Deployment for step by step instructions. 

. Build a Centos Linux VM to host Ansible controller. The Ansible controller can be located either on-premisses or in AWS cloud. If on-premisses, ssh connectivity to VPC, EC2 Linux instances and FSx storage clusters. 

. Setup Ansible controller following link:https://docs.netapp.com/us-en/netapp-solutions/automation/getting-started.html[Getting Started with NetApp solution automation] and "Setup the Ansible Control Node for CLI deployments on RHEL / CentOS" section.

. Clone a copy of automation toolkit from NetApp public GitHub site
+
[source, cli]
git clone https://github.com/NetApp-Automation/na_postgresql_aws_deploy_hadr.git

. From toolkit root directory, execute prerequisites playbooks to install required collections and libs.
+
[source, cli] 
ansible-playbook -i hosts requirements.yml
+ 
[source, cli]
ansible-galaxy collection install -r collections/requirements.yml --force --force-with-deps

. Retrieve the required EC2, FSx instances parameters for DB host variables file host_vars/* and global variables file fsx_vars.yml configuration
=====

.Configure hosts File
[%collapsible]
=====
Input primary FSx ONTAP cluster management IP and EC2 instances hosts names in hosts file

  # Primary FSx cluster management IP address
  [fsx_ontap]  
  172.30.15.33

  # Primary PostgreSQL DB server at primary site where database is initialized at deployment time
  [postgresql] 
  psql_01p ansible_ssh_private_key_file=psql_01p.pem

  # Primary PostgreSQL DB server at standby site where postgresql service is installed but disabled at deployment
  # Standby DB server at primary site, to setup this server comment out other servers in [dr_postgresql]
  # Standby DB server at standby site, to setup this server comment out other servers in [dr_postgresql]
  [dr_postgresql] --   
  psql_01s ansible_ssh_private_key_file=psql_01s.pem
  #psql_01ps ansible_ssh_private_key_file=psql_01ps.pem  
  #psql_01ss ansible_ssh_private_key_file=psql_01ss.pem  
=====

.Configure host_name.yml File in host_vars Folder
[%collapsible]
=====
include::../_include/aws_postgres_fsx_ec2_host_vars.adoc[]
=====

.Configure Global fsx_vars.yml File in vars Folder
[%collapsible]
=====
include::../_include/aws_postgres_fsx_ec2_fsx_vars.adoc[]
=====

.PostgreSQL Deployment and HA/DR setup
[%collapsible]
=====
. Create db vols on primary fsx cluster and setup postgresql on primary EC2 instance host
[source, cli]
ansible-playbook -i hosts postgresql_deploy.yml -u ec2-user --private-key psql_01p.pem -e @vars/fsx_vars.yml

. Setup the standby DR EC2 instance host
[source, cli]
ansible-playbook -i hosts postgresql_standby_setup.yml -u ec2-user --private-key psql_01s.pem -e @vars/fsx_vars.yml

. Setup FSx ontap cluster peering and database volumes replication
[source, cli]
ansible-playbook -i hosts fsx_replication_setup.yml -e @vars/fsx_vars.yml

. Consolidate single step PostgreSQL deployment and HA/DR setup
[source, cli]
ansible-playbook -i hosts postgresql_hadr_setup.yml -u ec2-user -e @vars/fsx_vars.yml
=====

.PostgreSQL Database Snapshot Backup and Replication to Standby Site
[%collapsible]
=====
tbd
=====

.Failover to Standby Site for DR
[%collapsible]
=====
tbd
=====

.Resync Replicated DB volumes after Failover Test
[%collapsible]
=====
tbd
=====


== AWS FSx ONTAP Deployment
// Are there other options for deployment (alternate 3rd party software, another way to address the same problem, etc.)?
// If so, BRIEFLY describe them here and point to documentation for more details on those options.

.<Description of Option 1>
[%collapsible]
=====
<enter the details of the option here>
=====

.<Description of Option 2>
[%collapsible]
=====
<enter the details of the option here>
=====

...

.<Description of Option n>
[%collapsible]
=====
<enter the details of the option here>
=====

== Additional Information
// Include references to other documentation (internal or external), videos, demos, blogs, etc. that support the solution.

* link:somewhere.html[Description of the document]
* link:somewhere-else.html[Description of another document]
