---
sidebar: sidebar
permalink: databases/snapctr_svcs_ora.html
keywords: Oracle, Database, SnapCenter, SnapShot, FlexClone, BlueXP, Database Backup, Database Restore, Database Clone
summary: "The solution provides overview and details for Oracle database backup, restore, clone using NetApp SnapCenter SaaS using BlueXP console." 
---

= TR-XXXX: Oracle Database Backup, Restore and Clone with SnapCenter Services 
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./../media/

Allen Cao, Niyaz Mohamed, NetApp

[.lead]

== Purpose

SnapCenter services is a SaaS version of classic SnapCenter database management UI tool that is available through NetApp BlueXP cloud management console. It is integral part of NetApp Cloud backup and data protection offering for database such as Oracle and HANA running on NetApp cloud storage. This SaaS based service simplifies traditional SnapCenter standalone server deployment that generally requires a Windows server and operates in a Windows domain environment.  

In this documentation, we demonstrate how you can setup SnapCenter services for backup, restore, and clone Oracle databases deployed to AWS FSx ONTAP storage and EC2 compute instances step by step. While much easier to setup and use, it delivers the similar key functionalities as available in legacy SnapCenter UI tool. 

This solution addresses the following use cases:

* Database backup via snapshot for Oracle database hosted in AWS FSx ONTAP
* Oracle database recovery in the case of a failure  
* Fast and storage efficient clone of primary database for DEV/TEST environment or any other use cases  

== Audience

This solution is intended for the following people:

* The DBA, who manages Oracle databases running on AWS FSx ONTAP storage.
* The solution architect, who is interested in testing Oracle database backup, restore, and clone in the public AWS cloud.
* The storage administrator, who supports and manages the AWS FSx ONTAP storage.
* The application owner, who owns applications that are deployed to AWS FSx ONTAP storage 

== Solution test and validation environment

The testing and validation of this solution was performed in an AWS FSx and EC2 environment that might not match the final deployment environment. For more information, see the section <<Key Factors for Deployment Consideration>>.

=== Architecture

image::snapctr_svcs_architecture.png["This image provides a detailed picture of the Cloud Backup for Application within BlueXP console, including the UI, connector and resources it manages."]

The above image provides a detailed picture of the Cloud Backup for Application within BlueXP console, including the UI, connector and resources it manages.

=== Hardware and software components

[%autowidth.stretch]
|===
3+^| *Hardware*
| FSx ONTAP storage | Current version offered by AWS | One FSx HA cluster in the same VPC and availability zone
| EC2 instance for compute | t2.xlarge/4vCPU/16G | Two EC2 T2 xlarge EC2 instances, one as primary DB server and the other as clone DB server 

3+^| *Software*
| RedHat Linux | RHEL-8.6.0_HVM-20220503-x86_64-2-Hourly2-GP2 | Deployed RedHat subscription for testing
| Oracle Grid Infrastructure | Version 19.18 | Applied RU patch p34762026_190000_Linux-x86-64.zip
| Oracle Database | Version 19.18 | Applied RU patch p34765931_190000_Linux-x86-64.zip
| Oracle OPatch | Version 12.2.0.1.36 | Latest patch p6880880_190000_Linux-x86-64.zip
| SnapCenter Service | Version |  v2.3.1.2324
|===

=== Key factors for deployment consideration

* *Connector to be deployed in the same VPC as database and FSx.* When possible the connector should be deployed in the same AWS VPC, which allow connectivity to both FSx storage and EC2 compute instance.

* *IAM role created for SnapCenter connector for AWS access.* The role in json format is available in detailed SnapCenter service documentation or when you launch connector deployment via BlueXP console, you are prompted for setting up the prerequisites. The role should be assigned to a AWS user account that owns the connector.

* *A ssh key pair created in AWS account.* The ssh key pair will be assigned to ec2-user for login to connector host, then deploy a database plugin to EC2 DB server host.  

* *PostgreSQL data and log placement.* Typical PostgreSQL deployments share the same root directory or volumes for data and log files. In our tests and validations, we have separated PostgreSQL data and logs into two separate volumes for performance. A soft link is used in the data directory to point to the log directory or volume that hosts PostgreSQL WAL logs and archived WAL logs.

* *PostgreSQL service startup delay timer.* This solution uses NFS mounted volumes to store the PostgreSQL database file and WAL log files. During a database host reboot, PostgreSQL service might try to start while the volume is not mounted. This results in database service startup failure. A 10 to 15 seconds timer delay is needed for the PostgreSQL database to start up correctly.

* *RPO/RTO for business continuity.* FSx data replication from primary to standby for DR is based on ASYNC, which means that the RPO depends on the frequency of Snapshot backups and SnapMirror replication. A higher frequency of Snapshot copy and SnapMirror replication reduces the RPO. Therefore, there is a balance between potential data loss in the event of a disaster and incremental storage cost. We have determined that Snapshot copy and SnapMirror replication can be implemented in as low as 5 minute intervals for RPO, and PostgreSQL can generally be recovered at the DR standby site in under a minute for the RTO.

* *Database backup.* After a PostgreSQL database is implemented or migrated into AWS FSx storage from an on-premisses data center, the data is auto-sync mirrored in the FSx HA pair for protection. Data is further protected with a replicated standby site in case of a disaster. For longer-term backup retention or data protection, NetApp recommends using the built-in PostgreSQL pg_basebackup utility to run a full database backup that can be ported to S3 blob storage.

== Solution Deployment

There are extensive NetApp documentations with a broader scope on protection of your cloud native application data. The goal of this documentation is to provide step by step procedures aided by screen shots that only covers the SnapCenter service deployment via BlueXP console to protect your Oracle database deployed to AWS FSx ONTAP and EC2 compute instance. This document fills in certain details that may be missing from general and overall instructions.

. Nevertheless, first read the general and overall instructions link:https://docs.netapp.com/us-en/cloud-manager-backup-restore/concept-protect-cloud-app-data-to-cloud.html#architecture[Protect your cloud native applications data^] and the sections related to Oracle and FSx ONTAP.

. Watch the following video walk through.
+
video::oracle-aws-fsx-part4c-bkup-restore-snapctrsvc_callout.mp4[]

=== Prerequisites for automated deployment

Deployment requires the following prerequisites.

. A primary Oracle database server on EC2 instance with an Oracle database fully deployed and running. 

. A FSx ONTAP cluster deployed in AWS that is hosting database above.

. An optional database server on EC2 instance that can be used for testing clone Oracle database to an alternative host for the purpose of supporting DEV/TEST workload or any use cases that requires a full data sets of production Oracle database. 

. If help is needed to meet the above prerequisites for Oracle database deployment on AWS FSx ONTAP and EC2 compute instance refer to this documentation link:aws_ora_fsx_ec2_iscsi_asm.htm[Oracle Database Deployment and Protection in AWS FSx/EC2 with iSCSI/ASM^] 


=== Configure the hosts file

Input the primary FSx ONTAP cluster management IP and EC2 instances hosts names into the hosts file.

  # Primary FSx cluster management IP address
  [fsx_ontap]  
  172.30.15.33

  # Primary PostgreSQL DB server at primary site where database is initialized at deployment time
  [postgresql] 
  psql_01p ansible_ssh_private_key_file=psql_01p.pem

  # Primary PostgreSQL DB server at standby site where postgresql service is installed but disabled at deployment
  # Standby DB server at primary site, to setup this server comment out other servers in [dr_postgresql]
  # Standby DB server at standby site, to setup this server comment out other servers in [dr_postgresql]
  [dr_postgresql] --   
  psql_01s ansible_ssh_private_key_file=psql_01s.pem
  #psql_01ps ansible_ssh_private_key_file=psql_01ps.pem  
  #psql_01ss ansible_ssh_private_key_file=psql_01ss.pem

=== Configure the host_name.yml file in the host_vars folder

include::../_include/aws_postgres_fsx_ec2_host_vars.adoc[]

=== Configure the global fsx_vars.yml file in the vars folder

include::../_include/aws_postgres_fsx_ec2_fsx_vars.adoc[]

=== PostgreSQL deployment and HA/DR setup

The following tasks deploy the PostgreSQL DB server service and initialize the database at the primary site on the primary EC2 DB server host. A standby primary EC2 DB server host is then set up at the standby site. Finally, DB volume replication is set up from the primary-site FSx cluster to the standby-site FSx cluster for disaster recovery.  

. Create DB volumes on the primary FSx cluster, and set up postgresql on the primary EC2 instance host.
[source, cli]
ansible-playbook -i hosts postgresql_deploy.yml -u ec2-user --private-key psql_01p.pem -e @vars/fsx_vars.yml

. Set up the standby DR EC2 instance host.
[source, cli]
ansible-playbook -i hosts postgresql_standby_setup.yml -u ec2-user --private-key psql_01s.pem -e @vars/fsx_vars.yml

. Set up FSx ONTAP cluster peering and database volume replication.
[source, cli]
ansible-playbook -i hosts fsx_replication_setup.yml -e @vars/fsx_vars.yml

. Consolidate the previous steps into a single-step PostgreSQL deployment and HA/DR setup. 
[source, cli]
ansible-playbook -i hosts postgresql_hadr_setup.yml -u ec2-user -e @vars/fsx_vars.yml

. For setting up a standby PostgreSQL DB host at either the primary or standby sites, comment out all other servers in the hosts file [dr_postgresql] section and then execute the postgresql_standby_setup.yml playbook with the respective target host (such as psql_01ps or standby EC2 compute instance at primary site). Make sure that a host parameters file such as `psql_01ps.yml` is configured under the `host_vars` directory. 
[source, cli]
[dr_postgresql] --   
#psql_01s ansible_ssh_private_key_file=psql_01s.pem
psql_01ps ansible_ssh_private_key_file=psql_01ps.pem  
#psql_01ss ansible_ssh_private_key_file=psql_01ss.pem
+
[source, cli]
ansible-playbook -i hosts postgresql_standby_setup.yml -u ec2-user --private-key psql_01ps.pem -e @vars/fsx_vars.yml

=== PostgreSQL database snapshot backup and replication to standby site

PostgreSQL database snapshot backup and replication to the standby site can be controlled and executed on the Ansible controller with a user-defined interval. We have validated that the interval can be as low as 5 minutes. Therefore, in the case of failure at the primary site, there is 5 minutes of potential data loss if failure occurs right before the next scheduled snapshot backup.

[source, cli]
*/15 * * * * /home/admin/na_postgresql_aws_deploy_hadr/data_log_snap.sh

=== Failover to Standby Site for DR

For testing the PostgreSQL HA/DR system as a DR exercise, execute failover and PostgreSQL database recovery on the primary standby EC2 DB instance on standby site by executing following playbook. In an actually DR scenario, execute the same for an actually failover to DR site.  

[source, cli]
ansible-playbook -i hosts postgresql_failover.yml -u ec2-user --private-key psql_01s.pem -e @vars/fsx_vars.yml 

=== Resync Replicated DB volumes after Failover Test

Run resync after the failover test to reestablish database-volume SnapMirror replication.

[source, cli]
ansible-playbook -i hosts postgresql_standby_resync.yml -u ec2-user --private-key psql_01s.pem -e @vars/fsx_vars.yml

=== Failover from primary EC2 DB server to standby EC2 DB server due to EC2 compute instance failure 

NetApp recommends running manual failover or using well-established OS cluster-ware that might require a license.

== Where to find additional information

To learn more about the information that is described in this document, review the following documents and/or websites:

* Amazon FSx for NetApp ONTAP
+
link:https://aws.amazon.com/fsx/netapp-ontap/[https://aws.amazon.com/fsx/netapp-ontap/^]

* Amazon EC2
+
link:https://aws.amazon.com/pm/ec2/?trk=36c6da98-7b20-48fa-8225-4784bced9843&sc_channel=ps&s_kwcid=AL!4422!3!467723097970!e!!g!!aws%20ec2&ef_id=Cj0KCQiA54KfBhCKARIsAJzSrdqwQrghn6I71jiWzSeaT9Uh1-vY-VfhJixF-xnv5rWwn2S7RqZOTQ0aAh7eEALw_wcB:G:s&s_kwcid=AL!4422!3!467723097970!e!!g!!aws%20ec2[https://aws.amazon.com/pm/ec2/?trk=36c6da98-7b20-48fa-8225-4784bced9843&sc_channel=ps&s_kwcid=AL!4422!3!467723097970!e!!g!!aws%20ec2&ef_id=Cj0KCQiA54KfBhCKARIsAJzSrdqwQrghn6I71jiWzSeaT9Uh1-vY-VfhJixF-xnv5rWwn2S7RqZOTQ0aAh7eEALw_wcB:G:s&s_kwcid=AL!4422!3!467723097970!e!!g!!aws%20ec2^]

* NetApp Solution Automation
+
link:https://docs.netapp.com/us-en/netapp-solutions/automation/automation_introduction.html[https://docs.netapp.com/us-en/netapp-solutions/automation/automation_introduction.html^]
