---
sidebar: sidebar
permalink: ehc/dro/dro-overview.html
keywords: NetApp Solutions, hybrid, multicloud, multi cloud, hyperscalers, vmware, disaster recovery orchestrator, DRO
summary:
---

= Disaster Recovery with FSx for ONTAP and VMC (AWS VMware Cloud)
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./../../media/

[.lead]
Author(s): Niyaz Mohamed, NetApp

== Overview

Disaster recovery to cloud is a resilient and cost-effective way of protecting the workloads against site outages and data corruption events (i.e., ransomware).  Leveraging SnapMirror, on-premises VMware workloads can be replicated to FSx for ONTAP running in AWS.  

Disaster Recovery Orchestrator (DRO) (a scripted solution with UI) can be used to seamlessly recover the workloads replicated from on-prem to FSx for ONTAP.  DRO automates the recovery from the SnapMirror level, through VM registration to VMC, to network mappings directly on NSX-T (included with all VMC environments).

image::dro-vmc-image1.png[]

== Getting started  

=== Deploy and configure VMware Cloud on AWS

link:https://www.vmware.com/products/vmc-on-aws.html[VMware Cloud on AWS] provides a cloud native experience for VMware based workloads in the AWS ecosystem. Each VMware Software-Defined Data Center (SDDC) runs in an Amazon Virtual Private Cloud (VPC) and provides a full VMware stack (including vCenter Server), NSX-T software-defined networking, vSAN software-defined storage, and one or more ESXi hosts that provide compute and storage resources to the workloads. To configure a VMC environment on AWS, follow the steps in this link:https://docs.netapp.com/us-en/netapp-solutions/ehc/aws/aws-setup.html[link]. A pilot light cluster can also be used for DR purposes. 

NOTE: In the initial release, DRO supports an existing pilot light cluster. On-demand SDDC creation will be available in an upcoming release.  

=== Provision and configure FSx for ONTAP

Amazon FSx for NetApp ONTAP is a fully managed service that provides highly reliable, scalable, high-performing, and feature-rich file storage built on the popular NetApp ONTAP file system. Follow the steps in this link:https://docs.netapp.com/us-en/netapp-solutions/ehc/aws/aws-native-overview.html[link] to provision and configure FSx for ONTAP.

=== Deploy and configure SnapMirror to FSx for ONTAP

The next step is to use NetApp BlueXP and discover the provisioned FSx for ONTAP on AWS and replicate the desired datastore volumes from on-premises environment to FSx for ONTAP with the appropriate frequencies and snapshot retentions:

image::dro-vmc-image2.png[]

Follow the steps in this link to configure BlueXP. You can also use the NetApp ONTAP CLI to schedule replication following this link.

NOTE: SnapMirror relationship is a pre-requisite and needs to be created beforehand.

== DRO Installation

To get started with DRO, use an Ubuntu operating system on the designated EC2 instance or virtual machine and make sure you meet the prerequisites, then install the package.

=== Pre-requisites

* Ensure connectivity to source and destination site vCenter and Storage systems exists
* DNS resolution should be in place if using DNS names else use IP addresses for vCenter/Storage systems 
* A user with root permissions (else sudo when using EC2 instance

=== OS requirements

* Ubuntu Focal 20.04 (LTS)
* The following packages must be installed on the designated agent virtual machine: 
** Docker 
** Docker-compose 
** Jq 

Change docker.sock to new permission:  sudo chmod 666 /var/run/docker.sock 

NOTE: The deploy.sh script will execute all the pre-requisites required.

=== Install the package

* Download installation package on the designated virtual machine: 
----
git clone <link here>
----

NOTE: The agent can be installed in on-premises or within AWS VPC.

* Unzip the package and run the deployment script and enter the host IP (e.g.: 10.10.10.10):  
----
tar xvf draas_package.tar
----

* Navigate to the directory and run the deploy script as below:
----
sudo sh deploy.sh  
----

* Access the UI using credentials as below:
----
Username: admin
Password: admin
----

image::dro-vmc-image3.png[]

== DRO Configuration

Once FSx for ONTAP and VMC have been configured properly, you may begin configuring DRO to automate the recovery of the on-prem workloads to VMC, leveraging the Read only SnapMirror copies on FSx for ONTAP.

It is recommended to deploy the DRO agent in AWS and to the same VPC where FSx for ONTAP is deployed (it can be peered connection too), so that DRO agent can communicate via network with your on-prem components as well as the FSx for ONTAP and VMC resources.

The first step is to discover and add the on-premises and cloud resources (both vcenter and storage) to DRO. Open DRO in a supported browser and use the default username and password (admin/admin) and Add Sites. Sites can also be added using Discover option.  Add the following platforms:

* On-Premises
** On-premises vCenter
** ONTAP Storage system
* Cloud
** VMC vCenter
** FSx for ONTAP

image::dro-vmc-image4.png[]

image::dro-vmc-image5.png[]

Once added, DRO will perform an automatic discovery and display the VMs that have corresponding SnapMirror replicas from the source storage to FSx for ONTAP.  DRO will automatically detect the networks and portgroups used by the VMs and will populate them. 

image::dro-vmc-image6.png[]

Next step is to group the required VMs into their functional groups as resource groups.

=== Resource Groupings

Once the platforms have been added, group the VMs you want to recover into resource groups.  DRO resource groups allow you to group set of dependent VMs into logical groups that contain their boot orders, boot delays, as well as optional application validations that can be executed upon recovery.

To start creating resource groups, click on the “Create New Resource Group” menu item.

. Access Resource groups, click on “Create New Resource Group”.
. On the “New resource group”, select the Source site from the dropdown and click “Create”
. Provide Resource Group Details and click on “Continue”
. Select appropriate VMs using the search option.
. Select the Boot Order and Boot delay (secs) for all the selected VMs. Set the order of power on sequence by selecting each virtual machine and setting up the priority for it. 3 is the default value for all virtual machines.
+
Options are as follows: 
+
1 – The first virtual machine to power on
3 – Default
5 – The last virtual machine to power on

. Click on “Create Resource Group”.

image::dro-vmc-image7.png[]

=== Replication Plans

To recover applications in the event of a disaster, a plan is necessary. Select the source and destination vCenter platforms from the drop down and pick the resource groups to be included in this plan, along with the grouping of how applications should be restored and powered on (i.e. domain controllers, then tier-1, then tier-2, etc). These are often called as blueprints as well. To define the recovery plan, navigate to the “Replication Plan” tab and click on New Replication Plan. 

To start creating replication plan, click on the “Create New Replication Plan”.

. Access Replication Plans, click on “Create New Replication Plan”.
+
image::dro-vmc-image8.png[]

. On the “New Replication Plan”, provide a name for plan and add recovery mappings by selecting Source Site, associated vCenter, Destination Site and associated vCenter.  
+
image::dro-vmc-image9.png[]

. Once Recovery mapping is done, select the cluster mapping.
+
image::dro-vmc-image10.png[]

. Select Resource Group Details and click on “Continue”

. Set Execution Order for Resource Group. This option enables to select the sequence of operations when multiple resource groups exist. 

. Once done, select Network Mapping to the appropriate segment.  The segments should already be provisioned within VMC and to map the VMs to those, select the appropriate segment.	

. Based on the selection of VMs, datastore mappings will be automatically selected.
+
NOTE: SnapMirror is at the volume level and hence all VMs will be replicated to the replication destination. Make sure to select all VMs that are part of the datastore. If not selected, only the virtual machines that are part of the replication plan will be processed.
+
image::dro-vmc-image11.png[]

. Under VM details, optionally resize the VMs CPU/RAM parameters; which can be very helpful when recovering large environments to smaller target clusters or for conducting DR tests without having to provision a one-to-one physical VMware infrastructure. Also modify the Boot Order and Boot delay (secs) for all the selected VMs across the resource groups. This is an additional option to modify the boot order if any changes required from what was selected during Resource group boot order selection. By default, the boot order selected during resource group selection is used, however any modifications can be done at this stage. 

. Click on “Create Replication Plan”.
+
image::dro-vmc-image12.png[]

Once the replication plan is created, failover, Test failover or migrate option can be exercised depending on the requirements. During failover and test failover options, the most recent SnapMirror snapshot is used, or a specific snapshot can be selected from a point-in-time snapshot (per the retention policy of the SnapMirror).  The point-in-time option can be very beneficial if facing a corruption event like ransomware, where the most recent replicas are already compromised or encrypted.  DRO will show all available point-in-times.  To trigger failover or test failover with the configuration specified in replication plan as is, you can click on Failover or Test failover.  

image::dro-vmc-image13.png[]
image::dro-vmc-image14.png[]

Replication plan can be monitored in the task menu:

image::dro-vmc-image15.png[]

Once the failover is triggered, the recovered items can be seen in the VMC vCenter (VMs, networks, datastores).  By default, the VMs will be recovered to Workload folder.

image::dro-vmc-image16.png[]

Failback can be triggered at the Replication Plan level. In case of Test Failover, tear down option can be used to rollback the changes and remove flexclone. For failback related to failover, it is a 2 step process. Select the Replication Plan and select “Reverse Data sync”. 

image::dro-vmc-image17.png[]

Once done, trigger failback to move back to original production site.

image::dro-vmc-image18.png[]
image::dro-vmc-image19.png[]

From NetApp BlueXP, we can see the replication health as broken off for the appropriate volumes (that get mapped to VMC as Read/Write volumes).  During test failover, DRO does not map the destination/replica volume.  Instead, it takes a FlexClone of the required SnapMirror (or Snapshot) and exposes the FlexClone, which does not consume additional physical capacity for FSx for ONTAP, and ensures that the volume is not modified, and replica jobs can continue even during DR tests or triage workflows.   Additionally, this ensures that if errors occur or corrupted data is recovered, the recovery can be cleaned up without the risk of the replica being destroyed

=== Ransomware Recovery

Recovering from ransomware can be a daunting task.  Specifically, it can be hard for IT organizations to pin-point what the “safe point of return is”, and once that’s determined, how to ensure that recovered workloads are safeguarded from the attacks reoccurring (from sleeping malware or through vulnerable applications).

DRO addresses these concerns by allowing organizations to recover from any available point-in-time and ensuring that the workloads are recovered to functional-yet-isolated networks, so that applications can function and communicate with each other, but are not exposed to any North-South traffic, giving security teams a safe place to conduct forensics – making sure there is no hidden/sleeping malware.

== Benefits
* Leverage the efficient and resilient replication of SnapMirror
* Recover to any available point-in-time, leveraging ONTAP snapshot retention
* Fully automate all required steps to recover hundreds to thousands of VMs, from the storage, compute, network, and application validation steps
* Workload recovery leverages ONTAP FlexClones – which don’t manipulate the replicated volume
** Avoid any risk of data corruption on the volumes/snapshots
** Avoid replication interruptions during DR test workflows
** Leverage the DR data and cloud compute for workflows beyond DR, such as DevTest, security testing, patch/upgrade testing, remediation testing
* CPU and RAM optimization can help lower the cloud costs by allowing recoveries to smaller compute clusters
